
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>helping_hands_rl_envs.simulators.pybullet.utils.transformations &#8212; HelpingHandsEnvs 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css" />
    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for helping_hands_rl_envs.simulators.pybullet.utils.transformations</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># transformations.py</span>

<span class="c1"># Copyright (c) 2006, Christoph Gohlke</span>
<span class="c1"># Copyright (c) 2006-2009, The Regents of the University of California</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># * Redistributions of source code must retain the above copyright</span>
<span class="c1">#   notice, this list of conditions and the following disclaimer.</span>
<span class="c1"># * Redistributions in binary form must reproduce the above copyright</span>
<span class="c1">#   notice, this list of conditions and the following disclaimer in the</span>
<span class="c1">#   documentation and/or other materials provided with the distribution.</span>
<span class="c1"># * Neither the name of the copyright holders nor the names of any</span>
<span class="c1">#   contributors may be used to endorse or promote products derived</span>
<span class="c1">#   from this software without specific prior written permission.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="c1"># ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<span class="c1"># LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="c1"># CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="c1"># SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="c1"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="c1"># CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="c1"># ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="c1"># POSSIBILITY OF SUCH DAMAGE.</span>

<span class="sd">&quot;&quot;&quot;Homogeneous Transformation Matrices and Quaternions.</span>

<span class="sd">A library for calculating 4x4 matrices for translating, rotating, reflecting,</span>
<span class="sd">scaling, shearing, projecting, orthogonalizing, and superimposing arrays of</span>
<span class="sd">3D homogeneous coordinates as well as for converting between rotation matrices,</span>
<span class="sd">Euler angles, and quaternions. Also includes an Arcball control object and</span>
<span class="sd">functions to decompose transformation matrices.</span>

<span class="sd">:Authors:</span>
<span class="sd">  `Christoph Gohlke &lt;http://www.lfd.uci.edu/~gohlke/&gt;`__,</span>
<span class="sd">  Laboratory for Fluorescence Dynamics, University of California, Irvine</span>

<span class="sd">:Version: 20090418</span>

<span class="sd">Requirements</span>
<span class="sd">------------</span>

<span class="sd">* `Python 2.6 &lt;http://www.python.org&gt;`__</span>
<span class="sd">* `Numpy 1.3 &lt;http://numpy.scipy.org&gt;`__</span>
<span class="sd">* `transformations.c 20090418 &lt;http://www.lfd.uci.edu/~gohlke/&gt;`__</span>
<span class="sd">  (optional implementation of some functions in C)</span>

<span class="sd">Notes</span>
<span class="sd">-----</span>

<span class="sd">Matrices (M) can be inverted using numpy.linalg.inv(M), concatenated using</span>
<span class="sd">numpy.dot(M0, M1), or used to transform homogeneous coordinates (v) using</span>
<span class="sd">numpy.dot(M, v) for shape (4, \*) &quot;point of arrays&quot;, respectively</span>
<span class="sd">numpy.dot(v, M.T) for shape (\*, 4) &quot;array of points&quot;.</span>

<span class="sd">Calculations are carried out with numpy.float64 precision.</span>

<span class="sd">This Python implementation is not optimized for speed.</span>

<span class="sd">Vector, point, quaternion, and matrix function arguments are expected to be</span>
<span class="sd">&quot;array like&quot;, i.e. tuple, list, or numpy arrays.</span>

<span class="sd">Return types are numpy arrays unless specified otherwise.</span>

<span class="sd">Angles are in radians unless specified otherwise.</span>

<span class="sd">Quaternions ix+jy+kz+w are represented as [x, y, z, w].</span>

<span class="sd">Use the transpose of transformation matrices for OpenGL glMultMatrixd().</span>

<span class="sd">A triple of Euler angles can be applied/interpreted in 24 ways, which can</span>
<span class="sd">be specified using a 4 character string or encoded 4-tuple:</span>

<span class="sd">  *Axes 4-string*: e.g. &#39;sxyz&#39; or &#39;ryxy&#39;</span>

<span class="sd">  - first character : rotations are applied to &#39;s&#39;tatic or &#39;r&#39;otating frame</span>
<span class="sd">  - remaining characters : successive rotation axis &#39;x&#39;, &#39;y&#39;, or &#39;z&#39;</span>

<span class="sd">  *Axes 4-tuple*: e.g. (0, 0, 0, 0) or (1, 1, 1, 1)</span>

<span class="sd">  - inner axis: code of axis (&#39;x&#39;:0, &#39;y&#39;:1, &#39;z&#39;:2) of rightmost matrix.</span>
<span class="sd">  - parity : even (0) if inner axis &#39;x&#39; is followed by &#39;y&#39;, &#39;y&#39; is followed</span>
<span class="sd">    by &#39;z&#39;, or &#39;z&#39; is followed by &#39;x&#39;. Otherwise odd (1).</span>
<span class="sd">  - repetition : first and last axis are same (1) or different (0).</span>
<span class="sd">  - frame : rotations are applied to static (0) or rotating (1) frame.</span>

<span class="sd">References</span>
<span class="sd">----------</span>

<span class="sd">(1)  Matrices and transformations. Ronald Goldman.</span>
<span class="sd">     In &quot;Graphics Gems I&quot;, pp 472-475. Morgan Kaufmann, 1990.</span>
<span class="sd">(2)  More matrices and transformations: shear and pseudo-perspective.</span>
<span class="sd">     Ronald Goldman. In &quot;Graphics Gems II&quot;, pp 320-323. Morgan Kaufmann, 1991.</span>
<span class="sd">(3)  Decomposing a matrix into simple transformations. Spencer Thomas.</span>
<span class="sd">     In &quot;Graphics Gems II&quot;, pp 320-323. Morgan Kaufmann, 1991.</span>
<span class="sd">(4)  Recovering the data from the transformation matrix. Ronald Goldman.</span>
<span class="sd">     In &quot;Graphics Gems II&quot;, pp 324-331. Morgan Kaufmann, 1991.</span>
<span class="sd">(5)  Euler angle conversion. Ken Shoemake.</span>
<span class="sd">     In &quot;Graphics Gems IV&quot;, pp 222-229. Morgan Kaufmann, 1994.</span>
<span class="sd">(6)  Arcball rotation control. Ken Shoemake.</span>
<span class="sd">     In &quot;Graphics Gems IV&quot;, pp 175-192. Morgan Kaufmann, 1994.</span>
<span class="sd">(7)  Representing attitude: Euler angles, unit quaternions, and rotation</span>
<span class="sd">     vectors. James Diebel. 2006.</span>
<span class="sd">(8)  A discussion of the solution for the best rotation to relate two sets</span>
<span class="sd">     of vectors. W Kabsch. Acta Cryst. 1978. A34, 827-828.</span>
<span class="sd">(9)  Closed-form solution of absolute orientation using unit quaternions.</span>
<span class="sd">     BKP Horn. J Opt Soc Am A. 1987. 4(4), 629-642.</span>
<span class="sd">(10) Quaternions. Ken Shoemake.</span>
<span class="sd">     http://www.sfu.ca/~jwa3/cmpt461/files/quatut.pdf</span>
<span class="sd">(11) From quaternion to matrix and back. JMP van Waveren. 2005.</span>
<span class="sd">     http://www.intel.com/cd/ids/developer/asmo-na/eng/293748.htm</span>
<span class="sd">(12) Uniform random rotations. Ken Shoemake.</span>
<span class="sd">     In &quot;Graphics Gems III&quot;, pp 124-132. Morgan Kaufmann, 1992.</span>


<span class="sd">Examples</span>
<span class="sd">--------</span>

<span class="sd">&gt;&gt;&gt; alpha, beta, gamma = 0.123, -1.234, 2.345</span>
<span class="sd">&gt;&gt;&gt; origin, xaxis, yaxis, zaxis = (0, 0, 0), (1, 0, 0), (0, 1, 0), (0, 0, 1)</span>
<span class="sd">&gt;&gt;&gt; I = identity_matrix()</span>
<span class="sd">&gt;&gt;&gt; Rx = rotation_matrix(alpha, xaxis)</span>
<span class="sd">&gt;&gt;&gt; Ry = rotation_matrix(beta, yaxis)</span>
<span class="sd">&gt;&gt;&gt; Rz = rotation_matrix(gamma, zaxis)</span>
<span class="sd">&gt;&gt;&gt; R = concatenate_matrices(Rx, Ry, Rz)</span>
<span class="sd">&gt;&gt;&gt; euler = euler_from_matrix(R, &#39;rxyz&#39;)</span>
<span class="sd">&gt;&gt;&gt; numpy.allclose([alpha, beta, gamma], euler)</span>
<span class="sd">True</span>
<span class="sd">&gt;&gt;&gt; Re = euler_matrix(alpha, beta, gamma, &#39;rxyz&#39;)</span>
<span class="sd">&gt;&gt;&gt; is_same_transform(R, Re)</span>
<span class="sd">True</span>
<span class="sd">&gt;&gt;&gt; al, be, ga = euler_from_matrix(Re, &#39;rxyz&#39;)</span>
<span class="sd">&gt;&gt;&gt; is_same_transform(Re, euler_matrix(al, be, ga, &#39;rxyz&#39;))</span>
<span class="sd">True</span>
<span class="sd">&gt;&gt;&gt; qx = quaternion_about_axis(alpha, xaxis)</span>
<span class="sd">&gt;&gt;&gt; qy = quaternion_about_axis(beta, yaxis)</span>
<span class="sd">&gt;&gt;&gt; qz = quaternion_about_axis(gamma, zaxis)</span>
<span class="sd">&gt;&gt;&gt; q = quaternion_multiply(qx, qy)</span>
<span class="sd">&gt;&gt;&gt; q = quaternion_multiply(q, qz)</span>
<span class="sd">&gt;&gt;&gt; Rq = quaternion_matrix(q)</span>
<span class="sd">&gt;&gt;&gt; is_same_transform(R, Rq)</span>
<span class="sd">True</span>
<span class="sd">&gt;&gt;&gt; S = scale_matrix(1.23, origin)</span>
<span class="sd">&gt;&gt;&gt; T = translation_matrix((1, 2, 3))</span>
<span class="sd">&gt;&gt;&gt; Z = shear_matrix(beta, xaxis, origin, zaxis)</span>
<span class="sd">&gt;&gt;&gt; R = random_rotation_matrix(numpy.random.rand(3))</span>
<span class="sd">&gt;&gt;&gt; M = concatenate_matrices(T, R, Z, S)</span>
<span class="sd">&gt;&gt;&gt; scale, shear, angles, trans, persp = decompose_matrix(M)</span>
<span class="sd">&gt;&gt;&gt; numpy.allclose(scale, 1.23)</span>
<span class="sd">True</span>
<span class="sd">&gt;&gt;&gt; numpy.allclose(trans, (1, 2, 3))</span>
<span class="sd">True</span>
<span class="sd">&gt;&gt;&gt; numpy.allclose(shear, (0, math.tan(beta), 0))</span>
<span class="sd">True</span>
<span class="sd">&gt;&gt;&gt; is_same_transform(R, euler_matrix(axes=&#39;sxyz&#39;, *angles))</span>
<span class="sd">True</span>
<span class="sd">&gt;&gt;&gt; M1 = compose_matrix(scale, shear, angles, trans, persp)</span>
<span class="sd">&gt;&gt;&gt; is_same_transform(M, M1)</span>
<span class="sd">True</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="c1"># Documentation in HTML format can be generated with Epydoc</span>
<span class="n">__docformat__</span> <span class="o">=</span> <span class="s2">&quot;restructuredtext en&quot;</span>


<div class="viewcode-block" id="identity_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.identity_matrix">[docs]</a><span class="k">def</span> <span class="nf">identity_matrix</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return 4x4 identity/unit matrix.</span>

<span class="sd">    &gt;&gt;&gt; I = identity_matrix()</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(I, numpy.dot(I, I))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; numpy.sum(I), numpy.trace(I)</span>
<span class="sd">    (4.0, 4.0)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(I, numpy.identity(4, dtype=numpy.float64))</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>


<div class="viewcode-block" id="translation_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.translation_matrix">[docs]</a><span class="k">def</span> <span class="nf">translation_matrix</span><span class="p">(</span><span class="n">direction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return matrix to translate by direction vector.</span>

<span class="sd">    &gt;&gt;&gt; v = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v, translation_matrix(v)[:3, 3])</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">direction</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="translation_from_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.translation_from_matrix">[docs]</a><span class="k">def</span> <span class="nf">translation_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return translation vector from translation matrix.</span>

<span class="sd">    &gt;&gt;&gt; v0 = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; v1 = translation_from_matrix(translation_matrix(v0))</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v0, v1)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="reflection_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.reflection_matrix">[docs]</a><span class="k">def</span> <span class="nf">reflection_matrix</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">normal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return matrix to mirror at plane defined by point and normal vector.</span>

<span class="sd">    &gt;&gt;&gt; v0 = numpy.random.random(4) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; v0[3] = 1.0</span>
<span class="sd">    &gt;&gt;&gt; v1 = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; R = reflection_matrix(v0, v1)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(2., numpy.trace(R))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v0, numpy.dot(R, v0))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; v2 = v0.copy()</span>
<span class="sd">    &gt;&gt;&gt; v2[:3] += v1</span>
<span class="sd">    &gt;&gt;&gt; v3 = v0.copy()</span>
<span class="sd">    &gt;&gt;&gt; v2[:3] -= v1</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v2, numpy.dot(R, v3))</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">normal</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">point</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">normal</span><span class="p">))</span> <span class="o">*</span> <span class="n">normal</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="reflection_from_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.reflection_from_matrix">[docs]</a><span class="k">def</span> <span class="nf">reflection_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return mirror plane point and normal vector from reflection matrix.</span>

<span class="sd">    &gt;&gt;&gt; v0 = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; v1 = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; M0 = reflection_matrix(v0, v1)</span>
<span class="sd">    &gt;&gt;&gt; point, normal = reflection_from_matrix(M0)</span>
<span class="sd">    &gt;&gt;&gt; M1 = reflection_matrix(point, normal)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(M0, M1)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># normal: unit eigenvector corresponding to eigenvalue -1</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no unit eigenvector corresponding to eigenvalue -1&quot;</span><span class="p">)</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="c1"># point: any unit eigenvector corresponding to eigenvalue 1</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no unit eigenvector corresponding to eigenvalue 1&quot;</span><span class="p">)</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">point</span> <span class="o">/=</span> <span class="n">point</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">normal</span></div>


<div class="viewcode-block" id="rotation_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.rotation_matrix">[docs]</a><span class="k">def</span> <span class="nf">rotation_matrix</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return matrix to rotate about axis defined by point and direction.</span>

<span class="sd">    &gt;&gt;&gt; angle = (random.random() - 0.5) * (2*math.pi)</span>
<span class="sd">    &gt;&gt;&gt; direc = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; point = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; R0 = rotation_matrix(angle, direc, point)</span>
<span class="sd">    &gt;&gt;&gt; R1 = rotation_matrix(angle-2*math.pi, direc, point)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(R0, R1)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; R0 = rotation_matrix(angle, direc, point)</span>
<span class="sd">    &gt;&gt;&gt; R1 = rotation_matrix(-angle, -direc, point)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(R0, R1)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; I = numpy.identity(4, numpy.float64)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(I, rotation_matrix(math.pi*2, direc))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(2., numpy.trace(rotation_matrix(math.pi/2,</span>
<span class="sd">    ...                                                direc, point)))</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sina</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">cosa</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">direction</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
    <span class="c1"># rotation matrix around unit vector</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="n">cosa</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">),</span>
                     <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>  <span class="n">cosa</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                     <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="n">cosa</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">cosa</span><span class="p">)</span>
    <span class="n">direction</span> <span class="o">*=</span> <span class="n">sina</span>
    <span class="n">R</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span> <span class="mf">0.0</span><span class="p">,</span>         <span class="o">-</span><span class="n">direction</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>  <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                      <span class="p">(</span> <span class="n">direction</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">,</span>          <span class="o">-</span><span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                      <span class="p">(</span><span class="o">-</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="mf">0.0</span><span class="p">)),</span>
                     <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>
    <span class="k">if</span> <span class="n">point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># rotation not around origin</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">point</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="rotation_from_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.rotation_from_matrix">[docs]</a><span class="k">def</span> <span class="nf">rotation_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return rotation angle and axis from rotation matrix.</span>

<span class="sd">    &gt;&gt;&gt; angle = (random.random() - 0.5) * (2*math.pi)</span>
<span class="sd">    &gt;&gt;&gt; direc = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; point = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; R0 = rotation_matrix(angle, direc, point)</span>
<span class="sd">    &gt;&gt;&gt; angle, direc, point = rotation_from_matrix(R0)</span>
<span class="sd">    &gt;&gt;&gt; R1 = rotation_matrix(angle, direc, point)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(R0, R1)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">R33</span> <span class="o">=</span> <span class="n">R</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="c1"># direction: unit eigenvector of R33 corresponding to eigenvalue of 1</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">R33</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no unit eigenvector corresponding to eigenvalue 1&quot;</span><span class="p">)</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="c1"># point: unit eigenvector of R33 corresponding to eigenvalue of 1</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no unit eigenvector corresponding to eigenvalue 1&quot;</span><span class="p">)</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Q</span><span class="p">[:,</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">point</span> <span class="o">/=</span> <span class="n">point</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="c1"># rotation angle depending on direction</span>
    <span class="n">cosa</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">R33</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">direction</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">:</span>
        <span class="n">sina</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">cosa</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">direction</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">:</span>
        <span class="n">sina</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">cosa</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">direction</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sina</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">cosa</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">direction</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">sina</span><span class="p">,</span> <span class="n">cosa</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">angle</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">point</span></div>


<div class="viewcode-block" id="scale_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.scale_matrix">[docs]</a><span class="k">def</span> <span class="nf">scale_matrix</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return matrix to scale by factor around origin in direction.</span>

<span class="sd">    Use factor -1 for point symmetry.</span>

<span class="sd">    &gt;&gt;&gt; v = (numpy.random.rand(4, 5) - 0.5) * 20.0</span>
<span class="sd">    &gt;&gt;&gt; v[3] = 1.0</span>
<span class="sd">    &gt;&gt;&gt; S = scale_matrix(-1.234)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(numpy.dot(S, v)[:3], -1.234*v[:3])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; factor = random.random() * 10 - 5</span>
<span class="sd">    &gt;&gt;&gt; origin = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; direct = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; S = scale_matrix(factor, origin)</span>
<span class="sd">    &gt;&gt;&gt; S = scale_matrix(factor, origin, direct)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># uniform scaling</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="n">factor</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>    <span class="mf">0.0</span><span class="p">,</span>    <span class="mf">0.0</span><span class="p">),</span>
                         <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>    <span class="n">factor</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>    <span class="mf">0.0</span><span class="p">),</span>
                         <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>    <span class="mf">0.0</span><span class="p">,</span>    <span class="n">factor</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                         <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>    <span class="mf">0.0</span><span class="p">,</span>    <span class="mf">0.0</span><span class="p">,</span>    <span class="mf">1.0</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">factor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># nonuniform scaling</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">direction</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">factor</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">factor</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">origin</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">direction</span><span class="p">))</span> <span class="o">*</span> <span class="n">direction</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="scale_from_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.scale_from_matrix">[docs]</a><span class="k">def</span> <span class="nf">scale_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return scaling factor, origin and direction from scaling matrix.</span>

<span class="sd">    &gt;&gt;&gt; factor = random.random() * 10 - 5</span>
<span class="sd">    &gt;&gt;&gt; origin = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; direct = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; S0 = scale_matrix(factor, origin)</span>
<span class="sd">    &gt;&gt;&gt; factor, origin, direction = scale_from_matrix(S0)</span>
<span class="sd">    &gt;&gt;&gt; S1 = scale_matrix(factor, origin, direction)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(S0, S1)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; S0 = scale_matrix(factor, origin, direct)</span>
<span class="sd">    &gt;&gt;&gt; factor, origin, direction = scale_from_matrix(S0)</span>
<span class="sd">    &gt;&gt;&gt; S1 = scale_matrix(factor, origin, direction)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(S0, S1)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">M33</span> <span class="o">=</span> <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">M33</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># direction: unit eigenvector corresponding to eigenvalue factor</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M33</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">factor</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">direction</span> <span class="o">/=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="c1"># uniform scaling</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">factor</span> <span class="o">+</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># origin: any eigenvector corresponding to eigenvalue 1</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no eigenvector corresponding to eigenvalue 1&quot;</span><span class="p">)</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">origin</span> <span class="o">/=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">factor</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">direction</span></div>


<div class="viewcode-block" id="projection_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.projection_matrix">[docs]</a><span class="k">def</span> <span class="nf">projection_matrix</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">perspective</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pseudo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return matrix to project onto plane defined by point and normal.</span>

<span class="sd">    Using either perspective point, projection direction, or none of both.</span>

<span class="sd">    If pseudo is True, perspective projections will preserve relative depth</span>
<span class="sd">    such that Perspective = dot(Orthogonal, PseudoPerspective).</span>

<span class="sd">    &gt;&gt;&gt; P = projection_matrix((0, 0, 0), (1, 0, 0))</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(P[1:, 1:], numpy.identity(4)[1:, 1:])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; point = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; normal = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; direct = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; persp = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; P0 = projection_matrix(point, normal)</span>
<span class="sd">    &gt;&gt;&gt; P1 = projection_matrix(point, normal, direction=direct)</span>
<span class="sd">    &gt;&gt;&gt; P2 = projection_matrix(point, normal, perspective=persp)</span>
<span class="sd">    &gt;&gt;&gt; P3 = projection_matrix(point, normal, perspective=persp, pseudo=True)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(P2, numpy.dot(P0, P3))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; P = projection_matrix((3, 0, 0), (1, 1, 0), (1, 0, 0))</span>
<span class="sd">    &gt;&gt;&gt; v0 = (numpy.random.rand(4, 5) - 0.5) * 20.0</span>
<span class="sd">    &gt;&gt;&gt; v0[3] = 1.0</span>
<span class="sd">    &gt;&gt;&gt; v1 = numpy.dot(P, v0)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v1[1], v0[1])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v1[0], 3.0-v1[1])</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">normal</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">perspective</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># perspective projection</span>
        <span class="n">perspective</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">perspective</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                                  <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">perspective</span><span class="o">-</span><span class="n">point</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">perspective</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pseudo</span><span class="p">:</span>
            <span class="c1"># preserve relative depth</span>
            <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
            <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">perspective</span><span class="o">+</span><span class="n">normal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">*</span> <span class="n">perspective</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">normal</span>
        <span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">perspective</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># parallel projection</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">direction</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">*</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># orthogonal projection</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span> <span class="o">*</span> <span class="n">normal</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="projection_from_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.projection_from_matrix">[docs]</a><span class="k">def</span> <span class="nf">projection_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">pseudo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return projection plane and perspective point from projection matrix.</span>

<span class="sd">    Return values are same as arguments for projection_matrix function:</span>
<span class="sd">    point, normal, direction, perspective, and pseudo.</span>

<span class="sd">    &gt;&gt;&gt; point = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; normal = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; direct = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; persp = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; P0 = projection_matrix(point, normal)</span>
<span class="sd">    &gt;&gt;&gt; result = projection_from_matrix(P0)</span>
<span class="sd">    &gt;&gt;&gt; P1 = projection_matrix(*result)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(P0, P1)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; P0 = projection_matrix(point, normal, direct)</span>
<span class="sd">    &gt;&gt;&gt; result = projection_from_matrix(P0)</span>
<span class="sd">    &gt;&gt;&gt; P1 = projection_matrix(*result)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(P0, P1)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; P0 = projection_matrix(point, normal, perspective=persp, pseudo=False)</span>
<span class="sd">    &gt;&gt;&gt; result = projection_from_matrix(P0, pseudo=False)</span>
<span class="sd">    &gt;&gt;&gt; P1 = projection_matrix(*result)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(P0, P1)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; P0 = projection_matrix(point, normal, perspective=persp, pseudo=True)</span>
<span class="sd">    &gt;&gt;&gt; result = projection_from_matrix(P0, pseudo=True)</span>
<span class="sd">    &gt;&gt;&gt; P1 = projection_matrix(*result)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(P0, P1)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">M33</span> <span class="o">=</span> <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pseudo</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="c1"># point: any eigenvector corresponding to eigenvalue 1</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">point</span> <span class="o">/=</span> <span class="n">point</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1"># direction: unit eigenvector corresponding to eigenvalue 0</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M33</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no eigenvector corresponding to eigenvalue 0&quot;</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">direction</span> <span class="o">/=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
        <span class="c1"># normal: unit eigenvector of M33.T corresponding to eigenvalue 0</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M33</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="c1"># parallel projection</span>
            <span class="n">normal</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">normal</span> <span class="o">/=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># orthogonal projection, where normal equals direction vector</span>
            <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># perspective projection</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;no eigenvector not corresponding to eigenvalue 0&quot;</span><span class="p">)</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">point</span> <span class="o">/=</span> <span class="n">point</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="o">-</span> <span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">perspective</span> <span class="o">=</span> <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">point</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">normal</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pseudo</span><span class="p">:</span>
            <span class="n">perspective</span> <span class="o">-=</span> <span class="n">normal</span>
        <span class="k">return</span> <span class="n">point</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">perspective</span><span class="p">,</span> <span class="n">pseudo</span></div>


<div class="viewcode-block" id="clip_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.clip_matrix">[docs]</a><span class="k">def</span> <span class="nf">clip_matrix</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">near</span><span class="p">,</span> <span class="n">far</span><span class="p">,</span> <span class="n">perspective</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return matrix to obtain normalized device coordinates from frustrum.</span>

<span class="sd">    The frustrum bounds are axis-aligned along x (left, right),</span>
<span class="sd">    y (bottom, top) and z (near, far).</span>

<span class="sd">    Normalized device coordinates are in range [-1, 1] if coordinates are</span>
<span class="sd">    inside the frustrum.</span>

<span class="sd">    If perspective is True the frustrum is a truncated pyramid with the</span>
<span class="sd">    perspective point at origin and direction along z axis, otherwise an</span>
<span class="sd">    orthographic canonical view volume (a box).</span>

<span class="sd">    Homogeneous coordinates transformed by the perspective clip matrix</span>
<span class="sd">    need to be dehomogenized (devided by w coordinate).</span>

<span class="sd">    &gt;&gt;&gt; frustrum = numpy.random.rand(6)</span>
<span class="sd">    &gt;&gt;&gt; frustrum[1] += frustrum[0]</span>
<span class="sd">    &gt;&gt;&gt; frustrum[3] += frustrum[2]</span>
<span class="sd">    &gt;&gt;&gt; frustrum[5] += frustrum[4]</span>
<span class="sd">    &gt;&gt;&gt; M = clip_matrix(*frustrum, perspective=False)</span>
<span class="sd">    &gt;&gt;&gt; numpy.dot(M, [frustrum[0], frustrum[2], frustrum[4], 1.0])</span>
<span class="sd">    array([-1., -1., -1.,  1.])</span>
<span class="sd">    &gt;&gt;&gt; numpy.dot(M, [frustrum[1], frustrum[3], frustrum[5], 1.0])</span>
<span class="sd">    array([ 1.,  1.,  1.,  1.])</span>
<span class="sd">    &gt;&gt;&gt; M = clip_matrix(*frustrum, perspective=True)</span>
<span class="sd">    &gt;&gt;&gt; v = numpy.dot(M, [frustrum[0], frustrum[2], frustrum[4], 1.0])</span>
<span class="sd">    &gt;&gt;&gt; v / v[3]</span>
<span class="sd">    array([-1., -1., -1.,  1.])</span>
<span class="sd">    &gt;&gt;&gt; v = numpy.dot(M, [frustrum[1], frustrum[3], frustrum[4], 1.0])</span>
<span class="sd">    &gt;&gt;&gt; v / v[3]</span>
<span class="sd">    array([ 1.,  1., -1.,  1.])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">left</span> <span class="o">&gt;=</span> <span class="n">right</span> <span class="ow">or</span> <span class="n">bottom</span> <span class="o">&gt;=</span> <span class="n">top</span> <span class="ow">or</span> <span class="n">near</span> <span class="o">&gt;=</span> <span class="n">far</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid frustrum&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">perspective</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">near</span> <span class="o">&lt;=</span> <span class="n">_EPS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid frustrum: near &lt;= 0&quot;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">near</span>
        <span class="n">M</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">t</span><span class="o">/</span><span class="p">(</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">right</span><span class="o">+</span><span class="n">left</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">),</span>
             <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="n">t</span><span class="o">/</span><span class="p">(</span><span class="n">top</span><span class="o">-</span><span class="n">bottom</span><span class="p">),</span> <span class="p">(</span><span class="n">top</span><span class="o">+</span><span class="n">bottom</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">top</span><span class="o">-</span><span class="n">bottom</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">),</span>
             <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">far</span><span class="o">+</span><span class="n">near</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">far</span><span class="o">-</span><span class="n">near</span><span class="p">),</span> <span class="n">t</span><span class="o">*</span><span class="n">far</span><span class="o">/</span><span class="p">(</span><span class="n">far</span><span class="o">-</span><span class="n">near</span><span class="p">)),</span>
             <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="p">((</span><span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">right</span><span class="o">+</span><span class="n">left</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">left</span><span class="o">-</span><span class="n">right</span><span class="p">)),</span>
             <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="n">top</span><span class="o">-</span><span class="n">bottom</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">top</span><span class="o">+</span><span class="n">bottom</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">bottom</span><span class="o">-</span><span class="n">top</span><span class="p">)),</span>
             <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="n">far</span><span class="o">-</span><span class="n">near</span><span class="p">),</span> <span class="p">(</span><span class="n">far</span><span class="o">+</span><span class="n">near</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">near</span><span class="o">-</span><span class="n">far</span><span class="p">)),</span>
             <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>


<div class="viewcode-block" id="shear_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.shear_matrix">[docs]</a><span class="k">def</span> <span class="nf">shear_matrix</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">normal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return matrix to shear by angle along direction vector on shear plane.</span>

<span class="sd">    The shear plane is defined by a point and normal vector. The direction</span>
<span class="sd">    vector must be orthogonal to the plane&#39;s normal vector.</span>

<span class="sd">    A point P is transformed by the shear matrix into P&quot; such that</span>
<span class="sd">    the vector P-P&quot; is parallel to the direction vector and its extent is</span>
<span class="sd">    given by the angle of P-P&#39;-P&quot;, where P&#39; is the orthogonal projection</span>
<span class="sd">    of P onto the shear plane.</span>

<span class="sd">    &gt;&gt;&gt; angle = (random.random() - 0.5) * 4*math.pi</span>
<span class="sd">    &gt;&gt;&gt; direct = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; point = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; normal = numpy.cross(direct, numpy.random.random(3))</span>
<span class="sd">    &gt;&gt;&gt; S = shear_matrix(angle, direct, point, normal)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(1.0, numpy.linalg.det(S))</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">normal</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">direction</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">direction</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;direction and normal vectors are not orthogonal&quot;</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">angle</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">angle</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">point</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">normal</span><span class="p">)</span> <span class="o">*</span> <span class="n">direction</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="shear_from_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.shear_from_matrix">[docs]</a><span class="k">def</span> <span class="nf">shear_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return shear angle, direction and plane from shear matrix.</span>

<span class="sd">    &gt;&gt;&gt; angle = (random.random() - 0.5) * 4*math.pi</span>
<span class="sd">    &gt;&gt;&gt; direct = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; point = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; normal = numpy.cross(direct, numpy.random.random(3))</span>
<span class="sd">    &gt;&gt;&gt; S0 = shear_matrix(angle, direct, point, normal)</span>
<span class="sd">    &gt;&gt;&gt; angle, direct, point, normal = shear_from_matrix(S0)</span>
<span class="sd">    &gt;&gt;&gt; S1 = shear_matrix(angle, direct, point, normal)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(S0, S1)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">M33</span> <span class="o">=</span> <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="c1"># normal: cross independent eigenvectors corresponding to the eigenvalue 1</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M33</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No two linear independent eigenvectors found </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">l</span><span class="p">)</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
    <span class="n">lenorm</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="k">for</span> <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i0</span><span class="p">],</span> <span class="n">V</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">lenorm</span><span class="p">:</span>
            <span class="n">lenorm</span> <span class="o">=</span> <span class="n">l</span>
            <span class="n">normal</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">normal</span> <span class="o">/=</span> <span class="n">lenorm</span>
    <span class="c1"># direction and angle</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M33</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">normal</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
    <span class="n">direction</span> <span class="o">/=</span> <span class="n">angle</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="c1"># point: eigenvector corresponding to eigenvalue 1</span>
    <span class="n">l</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no eigenvector corresponding to eigenvalue 1&quot;</span><span class="p">)</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">V</span><span class="p">[:,</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">point</span> <span class="o">/=</span> <span class="n">point</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">angle</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">normal</span></div>


<div class="viewcode-block" id="decompose_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.decompose_matrix">[docs]</a><span class="k">def</span> <span class="nf">decompose_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return sequence of transformations from transformation matrix.</span>

<span class="sd">    matrix : array_like</span>
<span class="sd">        Non-degenerative homogeneous transformation matrix</span>

<span class="sd">    Return tuple of:</span>
<span class="sd">        scale : vector of 3 scaling factors</span>
<span class="sd">        shear : list of shear factors for x-y, x-z, y-z axes</span>
<span class="sd">        angles : list of Euler angles about static x, y, z axes</span>
<span class="sd">        translate : translation vector along x, y, z axes</span>
<span class="sd">        perspective : perspective partition of matrix</span>

<span class="sd">    Raise ValueError if matrix is of wrong type or degenerative.</span>

<span class="sd">    &gt;&gt;&gt; T0 = translation_matrix((1, 2, 3))</span>
<span class="sd">    &gt;&gt;&gt; scale, shear, angles, trans, persp = decompose_matrix(T0)</span>
<span class="sd">    &gt;&gt;&gt; T1 = translation_matrix(trans)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(T0, T1)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; S = scale_matrix(0.123)</span>
<span class="sd">    &gt;&gt;&gt; scale, shear, angles, trans, persp = decompose_matrix(S)</span>
<span class="sd">    &gt;&gt;&gt; scale[0]</span>
<span class="sd">    0.123</span>
<span class="sd">    &gt;&gt;&gt; R0 = euler_matrix(1, 2, 3)</span>
<span class="sd">    &gt;&gt;&gt; scale, shear, angles, trans, persp = decompose_matrix(R0)</span>
<span class="sd">    &gt;&gt;&gt; R1 = euler_matrix(*angles)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(R0, R1)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">_EPS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;M[3, 3] is zero&quot;</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">/=</span> <span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">P</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Matrix is singular&quot;</span><span class="p">)</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">shear</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_EPS</span><span class="p">):</span>
        <span class="n">perspective</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">M</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">perspective</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="n">translate</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">row</span> <span class="o">=</span> <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">shear</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">shear</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">shear</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">shear</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">shear</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">shear</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">shear</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">scale</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">shear</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">/=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">row</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">angles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="o">-</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">angles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#angles[0] = math.atan2(row[1, 0], row[1, 1])</span>
        <span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">angles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">scale</span><span class="p">,</span> <span class="n">shear</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">translate</span><span class="p">,</span> <span class="n">perspective</span></div>


<div class="viewcode-block" id="compose_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.compose_matrix">[docs]</a><span class="k">def</span> <span class="nf">compose_matrix</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shear</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">perspective</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return transformation matrix from sequence of transformations.</span>

<span class="sd">    This is the inverse of the decompose_matrix function.</span>

<span class="sd">    Sequence of transformations:</span>
<span class="sd">        scale : vector of 3 scaling factors</span>
<span class="sd">        shear : list of shear factors for x-y, x-z, y-z axes</span>
<span class="sd">        angles : list of Euler angles about static x, y, z axes</span>
<span class="sd">        translate : translation vector along x, y, z axes</span>
<span class="sd">        perspective : perspective partition of matrix</span>

<span class="sd">    &gt;&gt;&gt; scale = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; shear = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; angles = (numpy.random.random(3) - 0.5) * (2*math.pi)</span>
<span class="sd">    &gt;&gt;&gt; trans = numpy.random.random(3) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; persp = numpy.random.random(4) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; M0 = compose_matrix(scale, shear, angles, trans, persp)</span>
<span class="sd">    &gt;&gt;&gt; result = decompose_matrix(M0)</span>
<span class="sd">    &gt;&gt;&gt; M1 = compose_matrix(*result)</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(M0, M1)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">perspective</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">P</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">perspective</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">translate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">T</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">translate</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">angles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">euler_matrix</span><span class="p">(</span><span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angles</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;sxyz&#39;</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shear</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">shear</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">shear</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">shear</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">S</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">S</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">S</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">/=</span> <span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="orthogonalization_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.orthogonalization_matrix">[docs]</a><span class="k">def</span> <span class="nf">orthogonalization_matrix</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">angles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return orthogonalization matrix for crystallographic cell coordinates.</span>

<span class="sd">    Angles are expected in degrees.</span>

<span class="sd">    The de-orthogonalization matrix is the inverse.</span>

<span class="sd">    &gt;&gt;&gt; O = orthogonalization_matrix((10., 10., 10.), (90., 90., 90.))</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(O[:3, :3], numpy.identity(3, float) * 10)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; O = orthogonalization_matrix([9.8, 12.0, 15.5], [87.2, 80.7, 69.7])</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(numpy.sum(O), 43.063229)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">lengths</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    <span class="n">sina</span><span class="p">,</span> <span class="n">sinb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    <span class="n">cosa</span><span class="p">,</span> <span class="n">cosb</span><span class="p">,</span> <span class="n">cosg</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    <span class="n">co</span> <span class="o">=</span> <span class="p">(</span><span class="n">cosa</span> <span class="o">*</span> <span class="n">cosb</span> <span class="o">-</span> <span class="n">cosg</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sina</span> <span class="o">*</span> <span class="n">sinb</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span>
        <span class="p">(</span> <span class="n">a</span><span class="o">*</span><span class="n">sinb</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">co</span><span class="o">*</span><span class="n">co</span><span class="p">),</span>  <span class="mf">0.0</span><span class="p">,</span>    <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">sinb</span><span class="o">*</span><span class="n">co</span><span class="p">,</span>                    <span class="n">b</span><span class="o">*</span><span class="n">sina</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="p">(</span> <span class="n">a</span><span class="o">*</span><span class="n">cosb</span><span class="p">,</span>                       <span class="n">b</span><span class="o">*</span><span class="n">cosa</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>   <span class="mf">0.0</span><span class="p">),</span>
        <span class="p">(</span> <span class="mf">0.0</span><span class="p">,</span>                          <span class="mf">0.0</span><span class="p">,</span>    <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>


<div class="viewcode-block" id="superimposition_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.superimposition_matrix">[docs]</a><span class="k">def</span> <span class="nf">superimposition_matrix</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">scaling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">usesvd</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return matrix to transform given vector set into second vector set.</span>

<span class="sd">    v0 and v1 are shape (3, \*) or (4, \*) arrays of at least 3 vectors.</span>

<span class="sd">    If usesvd is True, the weighted sum of squared deviations (RMSD) is</span>
<span class="sd">    minimized according to the algorithm by W. Kabsch [8]. Otherwise the</span>
<span class="sd">    quaternion based algorithm by B. Horn [9] is used (slower when using</span>
<span class="sd">    this Python implementation).</span>

<span class="sd">    The returned matrix performs rotation, translation and uniform scaling</span>
<span class="sd">    (if specified).</span>

<span class="sd">    &gt;&gt;&gt; v0 = numpy.random.rand(3, 10)</span>
<span class="sd">    &gt;&gt;&gt; M = superimposition_matrix(v0, v0)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(M, numpy.identity(4))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; R = random_rotation_matrix(numpy.random.random(3))</span>
<span class="sd">    &gt;&gt;&gt; v0 = ((1,0,0), (0,1,0), (0,0,1), (1,1,1))</span>
<span class="sd">    &gt;&gt;&gt; v1 = numpy.dot(R, v0)</span>
<span class="sd">    &gt;&gt;&gt; M = superimposition_matrix(v0, v1)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v1, numpy.dot(M, v0))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; v0 = (numpy.random.rand(4, 100) - 0.5) * 20.0</span>
<span class="sd">    &gt;&gt;&gt; v0[3] = 1.0</span>
<span class="sd">    &gt;&gt;&gt; v1 = numpy.dot(R, v0)</span>
<span class="sd">    &gt;&gt;&gt; M = superimposition_matrix(v0, v1)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v1, numpy.dot(M, v0))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; S = scale_matrix(random.random())</span>
<span class="sd">    &gt;&gt;&gt; T = translation_matrix(numpy.random.random(3)-0.5)</span>
<span class="sd">    &gt;&gt;&gt; M = concatenate_matrices(T, R, S)</span>
<span class="sd">    &gt;&gt;&gt; v1 = numpy.dot(M, v0)</span>
<span class="sd">    &gt;&gt;&gt; v0[:3] += numpy.random.normal(0.0, 1e-9, 300).reshape(3, -1)</span>
<span class="sd">    &gt;&gt;&gt; M = superimposition_matrix(v0, v1, scaling=True)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v1, numpy.dot(M, v0))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; M = superimposition_matrix(v0, v1, scaling=True, usesvd=False)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v1, numpy.dot(M, v0))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; v = numpy.empty((4, 100, 3), dtype=numpy.float64)</span>
<span class="sd">    &gt;&gt;&gt; v[:, :, 0] = v0</span>
<span class="sd">    &gt;&gt;&gt; M = superimposition_matrix(v0, v1, scaling=True, usesvd=False)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v1, numpy.dot(M, v[:, :, 0]))</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">v0</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">v1</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="n">v0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Vector sets are of wrong shape or type.&quot;</span><span class="p">)</span>

    <span class="c1"># move centroids to origin</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">-</span> <span class="n">t0</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">-</span> <span class="n">t1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">usesvd</span><span class="p">:</span>
        <span class="c1"># Singular Value Decomposition of covariance matrix</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v0</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="c1"># rotation matrix from SVD orthonormal bases</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">vh</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># R does not constitute right handed system</span>
            <span class="n">R</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">u</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">vh</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="c1"># homogeneous transformation matrix</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># compute symmetric matrix N</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">zz</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span> <span class="o">*</span> <span class="n">v1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xy</span><span class="p">,</span> <span class="n">yz</span><span class="p">,</span> <span class="n">zx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xz</span><span class="p">,</span> <span class="n">yx</span><span class="p">,</span> <span class="n">zy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="p">((</span><span class="n">xx</span><span class="o">+</span><span class="n">yy</span><span class="o">+</span><span class="n">zz</span><span class="p">,</span> <span class="n">yz</span><span class="o">-</span><span class="n">zy</span><span class="p">,</span>    <span class="n">zx</span><span class="o">-</span><span class="n">xz</span><span class="p">,</span>    <span class="n">xy</span><span class="o">-</span><span class="n">yx</span><span class="p">),</span>
             <span class="p">(</span><span class="n">yz</span><span class="o">-</span><span class="n">zy</span><span class="p">,</span>    <span class="n">xx</span><span class="o">-</span><span class="n">yy</span><span class="o">-</span><span class="n">zz</span><span class="p">,</span> <span class="n">xy</span><span class="o">+</span><span class="n">yx</span><span class="p">,</span>    <span class="n">zx</span><span class="o">+</span><span class="n">xz</span><span class="p">),</span>
             <span class="p">(</span><span class="n">zx</span><span class="o">-</span><span class="n">xz</span><span class="p">,</span>    <span class="n">xy</span><span class="o">+</span><span class="n">yx</span><span class="p">,</span>   <span class="o">-</span><span class="n">xx</span><span class="o">+</span><span class="n">yy</span><span class="o">-</span><span class="n">zz</span><span class="p">,</span> <span class="n">yz</span><span class="o">+</span><span class="n">zy</span><span class="p">),</span>
             <span class="p">(</span><span class="n">xy</span><span class="o">-</span><span class="n">yx</span><span class="p">,</span>    <span class="n">zx</span><span class="o">+</span><span class="n">xz</span><span class="p">,</span>    <span class="n">yz</span><span class="o">+</span><span class="n">zy</span><span class="p">,</span>   <span class="o">-</span><span class="n">xx</span><span class="o">-</span><span class="n">yy</span><span class="o">+</span><span class="n">zz</span><span class="p">))</span>
        <span class="c1"># quaternion: eigenvector corresponding to most positive eigenvalue</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">l</span><span class="p">)]</span>
        <span class="n">q</span> <span class="o">/=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="c1"># unit quaternion</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># move w component to end</span>
        <span class="c1"># homogeneous transformation matrix</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">quaternion_matrix</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="c1"># scale: ratio of rms deviations from centroid</span>
    <span class="k">if</span> <span class="n">scaling</span><span class="p">:</span>
        <span class="n">v0</span> <span class="o">*=</span> <span class="n">v0</span>
        <span class="n">v1</span> <span class="o">*=</span> <span class="n">v1</span>
        <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v0</span><span class="p">))</span>

    <span class="c1"># translation</span>
    <span class="n">M</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">T</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">t0</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="euler_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.euler_matrix">[docs]</a><span class="k">def</span> <span class="nf">euler_matrix</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">aj</span><span class="p">,</span> <span class="n">ak</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;sxyz&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return homogeneous rotation matrix from Euler angles and axis sequence.</span>

<span class="sd">    ai, aj, ak : Euler&#39;s roll, pitch and yaw angles</span>
<span class="sd">    axes : One of 24 axis sequences as string or encoded tuple</span>

<span class="sd">    &gt;&gt;&gt; R = euler_matrix(1, 2, 3, &#39;syxz&#39;)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(numpy.sum(R[0]), -1.34786452)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; R = euler_matrix(1, 2, 3, (0, 1, 0, 1))</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(numpy.sum(R[0]), -0.383436184)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; ai, aj, ak = (4.0*math.pi) * (numpy.random.random(3) - 0.5)</span>
<span class="sd">    &gt;&gt;&gt; for axes in _AXES2TUPLE.keys():</span>
<span class="sd">    ...    R = euler_matrix(ai, aj, ak, axes)</span>
<span class="sd">    &gt;&gt;&gt; for axes in _TUPLE2AXES.keys():</span>
<span class="sd">    ...    R = euler_matrix(ai, aj, ak, axes)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">firstaxis</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">repetition</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">_AXES2TUPLE</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">_TUPLE2AXES</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span>
        <span class="n">firstaxis</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">repetition</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">axes</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">firstaxis</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">_NEXT_AXIS</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">parity</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">_NEXT_AXIS</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">parity</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>
        <span class="n">ai</span><span class="p">,</span> <span class="n">ak</span> <span class="o">=</span> <span class="n">ak</span><span class="p">,</span> <span class="n">ai</span>
    <span class="k">if</span> <span class="n">parity</span><span class="p">:</span>
        <span class="n">ai</span><span class="p">,</span> <span class="n">aj</span><span class="p">,</span> <span class="n">ak</span> <span class="o">=</span> <span class="o">-</span><span class="n">ai</span><span class="p">,</span> <span class="o">-</span><span class="n">aj</span><span class="p">,</span> <span class="o">-</span><span class="n">ak</span>

    <span class="n">si</span><span class="p">,</span> <span class="n">sj</span><span class="p">,</span> <span class="n">sk</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ai</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aj</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ak</span><span class="p">)</span>
    <span class="n">ci</span><span class="p">,</span> <span class="n">cj</span><span class="p">,</span> <span class="n">ck</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ai</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">aj</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ak</span><span class="p">)</span>
    <span class="n">cc</span><span class="p">,</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">ci</span><span class="o">*</span><span class="n">ck</span><span class="p">,</span> <span class="n">ci</span><span class="o">*</span><span class="n">sk</span>
    <span class="n">sc</span><span class="p">,</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">si</span><span class="o">*</span><span class="n">ck</span><span class="p">,</span> <span class="n">si</span><span class="o">*</span><span class="n">sk</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">repetition</span><span class="p">:</span>
        <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span>
        <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="o">*</span><span class="n">si</span>
        <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="o">*</span><span class="n">ci</span>
        <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="o">*</span><span class="n">sk</span>
        <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">cj</span><span class="o">*</span><span class="n">ss</span><span class="o">+</span><span class="n">cc</span>
        <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">cj</span><span class="o">*</span><span class="n">cs</span><span class="o">-</span><span class="n">sc</span>
        <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sj</span><span class="o">*</span><span class="n">ck</span>
        <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="n">sc</span><span class="o">+</span><span class="n">cs</span>
        <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="n">cc</span><span class="o">-</span><span class="n">ss</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="n">ck</span>
        <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="o">*</span><span class="n">sc</span><span class="o">-</span><span class="n">cs</span>
        <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="o">*</span><span class="n">cc</span><span class="o">+</span><span class="n">ss</span>
        <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="n">sk</span>
        <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="o">*</span><span class="n">ss</span><span class="o">+</span><span class="n">cc</span>
        <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="o">*</span><span class="n">cs</span><span class="o">-</span><span class="n">sc</span>
        <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sj</span>
        <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="n">si</span>
        <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="n">ci</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="euler_from_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.euler_from_matrix">[docs]</a><span class="k">def</span> <span class="nf">euler_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;sxyz&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return Euler angles from rotation matrix for specified axis sequence.</span>

<span class="sd">    axes : One of 24 axis sequences as string or encoded tuple</span>

<span class="sd">    Note that many Euler angle triplets can describe one matrix.</span>

<span class="sd">    &gt;&gt;&gt; R0 = euler_matrix(1, 2, 3, &#39;syxz&#39;)</span>
<span class="sd">    &gt;&gt;&gt; al, be, ga = euler_from_matrix(R0, &#39;syxz&#39;)</span>
<span class="sd">    &gt;&gt;&gt; R1 = euler_matrix(al, be, ga, &#39;syxz&#39;)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(R0, R1)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; angles = (4.0*math.pi) * (numpy.random.random(3) - 0.5)</span>
<span class="sd">    &gt;&gt;&gt; for axes in _AXES2TUPLE.keys():</span>
<span class="sd">    ...    R0 = euler_matrix(axes=axes, *angles)</span>
<span class="sd">    ...    R1 = euler_matrix(axes=axes, *euler_from_matrix(R0, axes))</span>
<span class="sd">    ...    if not numpy.allclose(R0, R1): print axes, &quot;failed&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">firstaxis</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">repetition</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">_AXES2TUPLE</span><span class="p">[</span><span class="n">axes</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">_TUPLE2AXES</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span>
        <span class="n">firstaxis</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">repetition</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">axes</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">firstaxis</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">_NEXT_AXIS</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">parity</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">_NEXT_AXIS</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">parity</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">repetition</span><span class="p">:</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">sy</span> <span class="o">&gt;</span> <span class="n">_EPS</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>  <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
            <span class="n">ay</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span> <span class="n">sy</span><span class="p">,</span>       <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">az</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span> <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span>  <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">ay</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span> <span class="n">sy</span><span class="p">,</span>       <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">az</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cy</span> <span class="o">&gt;</span> <span class="n">_EPS</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span> <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>  <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
            <span class="n">ay</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>  <span class="n">cy</span><span class="p">)</span>
            <span class="n">az</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span> <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>  <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span>  <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">ay</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>  <span class="n">cy</span><span class="p">)</span>
            <span class="n">az</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="n">parity</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">az</span> <span class="o">=</span> <span class="o">-</span><span class="n">ax</span><span class="p">,</span> <span class="o">-</span><span class="n">ay</span><span class="p">,</span> <span class="o">-</span><span class="n">az</span>
    <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">az</span> <span class="o">=</span> <span class="n">az</span><span class="p">,</span> <span class="n">ax</span>
    <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">az</span></div>


<div class="viewcode-block" id="euler_from_quaternion"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.euler_from_quaternion">[docs]</a><span class="k">def</span> <span class="nf">euler_from_quaternion</span><span class="p">(</span><span class="n">quaternion</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;sxyz&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return Euler angles from quaternion for specified axis sequence.</span>

<span class="sd">    &gt;&gt;&gt; angles = euler_from_quaternion([0.06146124, 0, 0, 0.99810947])</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(angles, [0.123, 0, 0])</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">euler_from_matrix</span><span class="p">(</span><span class="n">quaternion_matrix</span><span class="p">(</span><span class="n">quaternion</span><span class="p">),</span> <span class="n">axes</span><span class="p">)</span></div>


<div class="viewcode-block" id="quaternion_from_euler"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.quaternion_from_euler">[docs]</a><span class="k">def</span> <span class="nf">quaternion_from_euler</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">aj</span><span class="p">,</span> <span class="n">ak</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;sxyz&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return quaternion from Euler angles and axis sequence.</span>

<span class="sd">    ai, aj, ak : Euler&#39;s roll, pitch and yaw angles</span>
<span class="sd">    axes : One of 24 axis sequences as string or encoded tuple</span>

<span class="sd">    &gt;&gt;&gt; q = quaternion_from_euler(1, 2, 3, &#39;ryxz&#39;)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(q, [0.310622, -0.718287, 0.444435, 0.435953])</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">firstaxis</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">repetition</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">_AXES2TUPLE</span><span class="p">[</span><span class="n">axes</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">_TUPLE2AXES</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span>
        <span class="n">firstaxis</span><span class="p">,</span> <span class="n">parity</span><span class="p">,</span> <span class="n">repetition</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">axes</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">firstaxis</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">_NEXT_AXIS</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">parity</span><span class="p">]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">_NEXT_AXIS</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">parity</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">frame</span><span class="p">:</span>
        <span class="n">ai</span><span class="p">,</span> <span class="n">ak</span> <span class="o">=</span> <span class="n">ak</span><span class="p">,</span> <span class="n">ai</span>
    <span class="k">if</span> <span class="n">parity</span><span class="p">:</span>
        <span class="n">aj</span> <span class="o">=</span> <span class="o">-</span><span class="n">aj</span>

    <span class="n">ai</span> <span class="o">/=</span> <span class="mf">2.0</span>
    <span class="n">aj</span> <span class="o">/=</span> <span class="mf">2.0</span>
    <span class="n">ak</span> <span class="o">/=</span> <span class="mf">2.0</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span>
    <span class="n">si</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span>
    <span class="n">cj</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">aj</span><span class="p">)</span>
    <span class="n">sj</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">aj</span><span class="p">)</span>
    <span class="n">ck</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ak</span><span class="p">)</span>
    <span class="n">sk</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ak</span><span class="p">)</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">ci</span><span class="o">*</span><span class="n">ck</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">ci</span><span class="o">*</span><span class="n">sk</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">si</span><span class="o">*</span><span class="n">ck</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">si</span><span class="o">*</span><span class="n">sk</span>

    <span class="n">quaternion</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">repetition</span><span class="p">:</span>
        <span class="n">quaternion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="p">(</span><span class="n">cs</span> <span class="o">+</span> <span class="n">sc</span><span class="p">)</span>
        <span class="n">quaternion</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="o">*</span><span class="p">(</span><span class="n">cc</span> <span class="o">+</span> <span class="n">ss</span><span class="p">)</span>
        <span class="n">quaternion</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="o">*</span><span class="p">(</span><span class="n">cs</span> <span class="o">-</span> <span class="n">sc</span><span class="p">)</span>
        <span class="n">quaternion</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="p">(</span><span class="n">cc</span> <span class="o">-</span> <span class="n">ss</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">quaternion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="n">sc</span> <span class="o">-</span> <span class="n">sj</span><span class="o">*</span><span class="n">cs</span>
        <span class="n">quaternion</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="n">ss</span> <span class="o">+</span> <span class="n">sj</span><span class="o">*</span><span class="n">cc</span>
        <span class="n">quaternion</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="n">cs</span> <span class="o">-</span> <span class="n">sj</span><span class="o">*</span><span class="n">sc</span>
        <span class="n">quaternion</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cj</span><span class="o">*</span><span class="n">cc</span> <span class="o">+</span> <span class="n">sj</span><span class="o">*</span><span class="n">ss</span>
    <span class="k">if</span> <span class="n">parity</span><span class="p">:</span>
        <span class="n">quaternion</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">quaternion</span></div>


<div class="viewcode-block" id="quaternion_about_axis"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.quaternion_about_axis">[docs]</a><span class="k">def</span> <span class="nf">quaternion_about_axis</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return quaternion for rotation about axis.</span>

<span class="sd">    &gt;&gt;&gt; q = quaternion_about_axis(0.123, (1, 0, 0))</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(q, [0.06146124, 0, 0, 0.99810947])</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">quaternion</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">quaternion</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">qlen</span> <span class="o">=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">quaternion</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">qlen</span> <span class="o">&gt;</span> <span class="n">_EPS</span><span class="p">:</span>
        <span class="n">quaternion</span> <span class="o">*=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">qlen</span>
    <span class="n">quaternion</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">quaternion</span></div>


<div class="viewcode-block" id="quaternion_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.quaternion_matrix">[docs]</a><span class="k">def</span> <span class="nf">quaternion_matrix</span><span class="p">(</span><span class="n">quaternion</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return homogeneous rotation matrix from quaternion.</span>

<span class="sd">    &gt;&gt;&gt; R = quaternion_matrix([0.06146124, 0, 0, 0.99810947])</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(R, rotation_matrix(0.123, (1, 0, 0)))</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">quaternion</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">nq</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nq</span> <span class="o">&lt;</span> <span class="n">_EPS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">*=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">nq</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span>
        <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>     <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>     <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="p">(</span>    <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>     <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="p">(</span>    <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>     <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="p">(</span>                <span class="mf">0.0</span><span class="p">,</span>                 <span class="mf">0.0</span><span class="p">,</span>                 <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>


<div class="viewcode-block" id="quaternion_from_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.quaternion_from_matrix">[docs]</a><span class="k">def</span> <span class="nf">quaternion_from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return quaternion from rotation matrix.</span>

<span class="sd">    &gt;&gt;&gt; R = rotation_matrix(0.123, (1, 2, 3))</span>
<span class="sd">    &gt;&gt;&gt; q = quaternion_from_matrix(R)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(q, [0.0164262, 0.0328524, 0.0492786, 0.9981095])</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">4</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
        <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">q</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">q</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">*=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">q</span></div>


<div class="viewcode-block" id="quaternion_multiply"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.quaternion_multiply">[docs]</a><span class="k">def</span> <span class="nf">quaternion_multiply</span><span class="p">(</span><span class="n">quaternion1</span><span class="p">,</span> <span class="n">quaternion0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return multiplication of two quaternions.</span>

<span class="sd">    &gt;&gt;&gt; q = quaternion_multiply([1, -2, 3, 4], [-5, 6, 7, 8])</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(q, [-44, -14, 48, 28])</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">w0</span> <span class="o">=</span> <span class="n">quaternion0</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z1</span><span class="p">,</span> <span class="n">w1</span> <span class="o">=</span> <span class="n">quaternion1</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span>
         <span class="n">x1</span><span class="o">*</span><span class="n">w0</span> <span class="o">+</span> <span class="n">y1</span><span class="o">*</span><span class="n">z0</span> <span class="o">-</span> <span class="n">z1</span><span class="o">*</span><span class="n">y0</span> <span class="o">+</span> <span class="n">w1</span><span class="o">*</span><span class="n">x0</span><span class="p">,</span>
        <span class="o">-</span><span class="n">x1</span><span class="o">*</span><span class="n">z0</span> <span class="o">+</span> <span class="n">y1</span><span class="o">*</span><span class="n">w0</span> <span class="o">+</span> <span class="n">z1</span><span class="o">*</span><span class="n">x0</span> <span class="o">+</span> <span class="n">w1</span><span class="o">*</span><span class="n">y0</span><span class="p">,</span>
         <span class="n">x1</span><span class="o">*</span><span class="n">y0</span> <span class="o">-</span> <span class="n">y1</span><span class="o">*</span><span class="n">x0</span> <span class="o">+</span> <span class="n">z1</span><span class="o">*</span><span class="n">w0</span> <span class="o">+</span> <span class="n">w1</span><span class="o">*</span><span class="n">z0</span><span class="p">,</span>
        <span class="o">-</span><span class="n">x1</span><span class="o">*</span><span class="n">x0</span> <span class="o">-</span> <span class="n">y1</span><span class="o">*</span><span class="n">y0</span> <span class="o">-</span> <span class="n">z1</span><span class="o">*</span><span class="n">z0</span> <span class="o">+</span> <span class="n">w1</span><span class="o">*</span><span class="n">w0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>


<div class="viewcode-block" id="quaternion_conjugate"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.quaternion_conjugate">[docs]</a><span class="k">def</span> <span class="nf">quaternion_conjugate</span><span class="p">(</span><span class="n">quaternion</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return conjugate of quaternion.</span>

<span class="sd">    &gt;&gt;&gt; q0 = random_quaternion()</span>
<span class="sd">    &gt;&gt;&gt; q1 = quaternion_conjugate(q0)</span>
<span class="sd">    &gt;&gt;&gt; q1[3] == q0[3] and all(q1[:3] == -q0[:3])</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="o">-</span><span class="n">quaternion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">quaternion</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="o">-</span><span class="n">quaternion</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">quaternion</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>


<div class="viewcode-block" id="quaternion_inverse"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.quaternion_inverse">[docs]</a><span class="k">def</span> <span class="nf">quaternion_inverse</span><span class="p">(</span><span class="n">quaternion</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return inverse of quaternion.</span>

<span class="sd">    &gt;&gt;&gt; q0 = random_quaternion()</span>
<span class="sd">    &gt;&gt;&gt; q1 = quaternion_inverse(q0)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(quaternion_multiply(q0, q1), [0, 0, 0, 1])</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">quaternion_conjugate</span><span class="p">(</span><span class="n">quaternion</span><span class="p">)</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">quaternion</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">)</span></div>


<div class="viewcode-block" id="quaternion_slerp"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.quaternion_slerp">[docs]</a><span class="k">def</span> <span class="nf">quaternion_slerp</span><span class="p">(</span><span class="n">quat0</span><span class="p">,</span> <span class="n">quat1</span><span class="p">,</span> <span class="n">fraction</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shortestpath</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return spherical linear interpolation between two quaternions.</span>

<span class="sd">    &gt;&gt;&gt; q0 = random_quaternion()</span>
<span class="sd">    &gt;&gt;&gt; q1 = random_quaternion()</span>
<span class="sd">    &gt;&gt;&gt; q = quaternion_slerp(q0, q1, 0.0)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(q, q0)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; q = quaternion_slerp(q0, q1, 1.0, 1)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(q, q1)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; q = quaternion_slerp(q0, q1, 0.5)</span>
<span class="sd">    &gt;&gt;&gt; angle = math.acos(numpy.dot(q0, q))</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(2.0, math.acos(numpy.dot(q0, q1)) / angle) or \</span>
<span class="sd">        numpy.allclose(2.0, math.acos(-numpy.dot(q0, q1)) / angle)</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q0</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">quat0</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="n">unit_vector</span><span class="p">(</span><span class="n">quat1</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">fraction</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q0</span>
    <span class="k">elif</span> <span class="n">fraction</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q1</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">q0</span><span class="p">,</span> <span class="n">q1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">_EPS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q0</span>
    <span class="k">if</span> <span class="n">shortestpath</span> <span class="ow">and</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="c1"># invert rotation</span>
        <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">d</span>
        <span class="n">q1</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">spin</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">_EPS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q0</span>
    <span class="n">isin</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">q0</span> <span class="o">*=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">fraction</span><span class="p">)</span> <span class="o">*</span> <span class="n">angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">isin</span>
    <span class="n">q1</span> <span class="o">*=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">fraction</span> <span class="o">*</span> <span class="n">angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">isin</span>
    <span class="n">q0</span> <span class="o">+=</span> <span class="n">q1</span>
    <span class="k">return</span> <span class="n">q0</span></div>


<div class="viewcode-block" id="random_quaternion"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.random_quaternion">[docs]</a><span class="k">def</span> <span class="nf">random_quaternion</span><span class="p">(</span><span class="n">rand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return uniform random unit quaternion.</span>

<span class="sd">    rand: array like or None</span>
<span class="sd">        Three independent random variables that are uniformly distributed</span>
<span class="sd">        between 0 and 1.</span>

<span class="sd">    &gt;&gt;&gt; q = random_quaternion()</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(1.0, vector_norm(q))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; q = random_quaternion(numpy.random.random(3))</span>
<span class="sd">    &gt;&gt;&gt; q.shape</span>
<span class="sd">    (4,)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rand</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rand</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">rand</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rand</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pi2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">2.0</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">pi2</span> <span class="o">*</span> <span class="n">rand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">pi2</span> <span class="o">*</span> <span class="n">rand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">r1</span><span class="p">,</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">r1</span><span class="p">,</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span><span class="o">*</span><span class="n">r2</span><span class="p">,</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span><span class="o">*</span><span class="n">r2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span></div>


<div class="viewcode-block" id="random_rotation_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.random_rotation_matrix">[docs]</a><span class="k">def</span> <span class="nf">random_rotation_matrix</span><span class="p">(</span><span class="n">rand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return uniform random rotation matrix.</span>

<span class="sd">    rnd: array like</span>
<span class="sd">        Three independent random variables that are uniformly distributed</span>
<span class="sd">        between 0 and 1 for each returned quaternion.</span>

<span class="sd">    &gt;&gt;&gt; R = random_rotation_matrix()</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(numpy.dot(R.T, R), numpy.identity(4))</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">quaternion_matrix</span><span class="p">(</span><span class="n">random_quaternion</span><span class="p">(</span><span class="n">rand</span><span class="p">))</span></div>


<div class="viewcode-block" id="Arcball"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.Arcball">[docs]</a><span class="k">class</span> <span class="nc">Arcball</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Virtual Trackball Control.</span>

<span class="sd">    &gt;&gt;&gt; ball = Arcball()</span>
<span class="sd">    &gt;&gt;&gt; ball = Arcball(initial=numpy.identity(4))</span>
<span class="sd">    &gt;&gt;&gt; ball.place([320, 320], 320)</span>
<span class="sd">    &gt;&gt;&gt; ball.down([500, 250])</span>
<span class="sd">    &gt;&gt;&gt; ball.drag([475, 275])</span>
<span class="sd">    &gt;&gt;&gt; R = ball.matrix()</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(numpy.sum(R), 3.90583455)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; ball = Arcball(initial=[0, 0, 0, 1])</span>
<span class="sd">    &gt;&gt;&gt; ball.place([320, 320], 320)</span>
<span class="sd">    &gt;&gt;&gt; ball.setaxes([1,1,0], [-1, 1, 0])</span>
<span class="sd">    &gt;&gt;&gt; ball.setconstrain(True)</span>
<span class="sd">    &gt;&gt;&gt; ball.down([400, 200])</span>
<span class="sd">    &gt;&gt;&gt; ball.drag([200, 400])</span>
<span class="sd">    &gt;&gt;&gt; R = ball.matrix()</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(numpy.sum(R), 0.2055924)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; ball.next()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize virtual trackball control.</span>

<span class="sd">        initial : quaternion or rotation matrix</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_radius</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vdown</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constrain</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qdown</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">initial</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">initial</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_qdown</span> <span class="o">=</span> <span class="n">quaternion_from_matrix</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">initial</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">):</span>
                <span class="n">initial</span> <span class="o">/=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_qdown</span> <span class="o">=</span> <span class="n">initial</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;initial not a quaternion or matrix.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_qnow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qpre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qdown</span>

<div class="viewcode-block" id="Arcball.place"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.Arcball.place">[docs]</a>    <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Place Arcball, e.g. when window size changes.</span>

<span class="sd">        center : sequence[2]</span>
<span class="sd">            Window coordinates of trackball center.</span>
<span class="sd">        radius : float</span>
<span class="sd">            Radius of trackball in window coordinates.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="Arcball.setaxes"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.Arcball.setaxes">[docs]</a>    <span class="k">def</span> <span class="nf">setaxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">axes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set axes to constrain rotations.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">unit_vector</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">]</span></div>

<div class="viewcode-block" id="Arcball.setconstrain"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.Arcball.setconstrain">[docs]</a>    <span class="k">def</span> <span class="nf">setconstrain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constrain</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set state of constrain to axis mode.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constrain</span> <span class="o">=</span> <span class="n">constrain</span> <span class="o">==</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Arcball.getconstrain"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.Arcball.getconstrain">[docs]</a>    <span class="k">def</span> <span class="nf">getconstrain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return state of constrain to axis mode.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constrain</span></div>

<div class="viewcode-block" id="Arcball.down"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.Arcball.down">[docs]</a>    <span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set initial cursor window coordinates and pick constrain-axis.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vdown</span> <span class="o">=</span> <span class="n">arcball_map_to_sphere</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radius</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qdown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qpre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qnow</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constrain</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span> <span class="o">=</span> <span class="n">arcball_nearest_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vdown</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vdown</span> <span class="o">=</span> <span class="n">arcball_constrain_to_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vdown</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Arcball.drag"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.Arcball.drag">[docs]</a>    <span class="k">def</span> <span class="nf">drag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update current cursor window coordinates.&quot;&quot;&quot;</span>
        <span class="n">vnow</span> <span class="o">=</span> <span class="n">arcball_map_to_sphere</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radius</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vnow</span> <span class="o">=</span> <span class="n">arcball_constrain_to_axis</span><span class="p">(</span><span class="n">vnow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_qpre</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qnow</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vdown</span><span class="p">,</span> <span class="n">vnow</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">_EPS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qnow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qdown</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vdown</span><span class="p">,</span> <span class="n">vnow</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_qnow</span> <span class="o">=</span> <span class="n">quaternion_multiply</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qdown</span><span class="p">)</span></div>

<div class="viewcode-block" id="Arcball.next"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.Arcball.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acceleration</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Continue rotation in direction of last drag.&quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">quaternion_slerp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qpre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qnow</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">+</span><span class="n">acceleration</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_qpre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qnow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qnow</span><span class="p">,</span> <span class="n">q</span></div>

<div class="viewcode-block" id="Arcball.matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.Arcball.matrix">[docs]</a>    <span class="k">def</span> <span class="nf">matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return homogeneous rotation matrix.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">quaternion_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qnow</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="arcball_map_to_sphere"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.arcball_map_to_sphere">[docs]</a><span class="k">def</span> <span class="nf">arcball_map_to_sphere</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return unit sphere coordinates from window coordinates.&quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">radius</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">radius</span><span class="p">,</span>
                     <span class="mf">0.0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">/=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="c1"># position outside of sphere</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span></div>


<div class="viewcode-block" id="arcball_constrain_to_axis"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.arcball_constrain_to_axis">[docs]</a><span class="k">def</span> <span class="nf">arcball_constrain_to_axis</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return sphere point perpendicular to axis.&quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">-=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="c1"># on plane</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">vector_norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="n">_EPS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">v</span> <span class="o">/=</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">v</span>
    <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unit_vector</span><span class="p">([</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="arcball_nearest_axis"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.arcball_nearest_axis">[docs]</a><span class="k">def</span> <span class="nf">arcball_nearest_axis</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return axis, which arc is nearest to point.&quot;&quot;&quot;</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">nearest</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">arcball_constrain_to_axis</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">axis</span><span class="p">),</span> <span class="n">point</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">mx</span><span class="p">:</span>
            <span class="n">nearest</span> <span class="o">=</span> <span class="n">axis</span>
            <span class="n">mx</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">return</span> <span class="n">nearest</span></div>


<span class="c1"># epsilon for testing whether a number is close to zero</span>
<span class="n">_EPS</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="mf">4.0</span>

<span class="c1"># axis sequences for Euler angles</span>
<span class="n">_NEXT_AXIS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># map axes strings to/from tuples of inner axis, parity, repetition, frame</span>
<span class="n">_AXES2TUPLE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sxyz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;sxyx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;sxzy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;sxzx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;syzx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;syzy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;syxz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;syxy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;szxy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;szxz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;szyx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;szyz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s1">&#39;rzyx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;rxyx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;ryzx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s1">&#39;rxzx&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;rxzy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;ryzy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s1">&#39;rzxy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;ryxy&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;ryxz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s1">&#39;rzxz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;rxyz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;rzyz&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>

<span class="n">_TUPLE2AXES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_AXES2TUPLE</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

<span class="c1"># helper functions</span>

<div class="viewcode-block" id="vector_norm"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.vector_norm">[docs]</a><span class="k">def</span> <span class="nf">vector_norm</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return length, i.e. eucledian norm, of ndarray along axis.</span>

<span class="sd">    &gt;&gt;&gt; v = numpy.random.random(3)</span>
<span class="sd">    &gt;&gt;&gt; n = vector_norm(v)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(n, numpy.linalg.norm(v))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; v = numpy.random.rand(6, 5, 3)</span>
<span class="sd">    &gt;&gt;&gt; n = vector_norm(v, axis=-1)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(n, numpy.sqrt(numpy.sum(v*v, axis=2)))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; n = vector_norm(v, axis=1)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(n, numpy.sqrt(numpy.sum(v*v, axis=1)))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; v = numpy.random.rand(5, 4, 3)</span>
<span class="sd">    &gt;&gt;&gt; n = numpy.empty((5, 3), dtype=numpy.float64)</span>
<span class="sd">    &gt;&gt;&gt; vector_norm(v, axis=1, out=n)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(n, numpy.sqrt(numpy.sum(v*v, axis=1)))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; vector_norm([])</span>
<span class="sd">    0.0</span>
<span class="sd">    &gt;&gt;&gt; vector_norm([1.0])</span>
<span class="sd">    1.0</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">*=</span> <span class="n">data</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">*=</span> <span class="n">data</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span></div>


<div class="viewcode-block" id="unit_vector"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.unit_vector">[docs]</a><span class="k">def</span> <span class="nf">unit_vector</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return ndarray normalized by length, i.e. eucledian norm, along axis.</span>

<span class="sd">    &gt;&gt;&gt; v0 = numpy.random.random(3)</span>
<span class="sd">    &gt;&gt;&gt; v1 = unit_vector(v0)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v1, v0 / numpy.linalg.norm(v0))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; v0 = numpy.random.rand(5, 4, 3)</span>
<span class="sd">    &gt;&gt;&gt; v1 = unit_vector(v0, axis=-1)</span>
<span class="sd">    &gt;&gt;&gt; v2 = v0 / numpy.expand_dims(numpy.sqrt(numpy.sum(v0*v0, axis=2)), 2)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v1, v2)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; v1 = unit_vector(v0, axis=1)</span>
<span class="sd">    &gt;&gt;&gt; v2 = v0 / numpy.expand_dims(numpy.sqrt(numpy.sum(v0*v0, axis=1)), 1)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v1, v2)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; v1 = numpy.empty((5, 4, 3), dtype=numpy.float64)</span>
<span class="sd">    &gt;&gt;&gt; unit_vector(v0, axis=1, out=v1)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(v1, v2)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; list(unit_vector([]))</span>
<span class="sd">    []</span>
<span class="sd">    &gt;&gt;&gt; list(unit_vector([1.0]))</span>
<span class="sd">    [1.0]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">/=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">out</span>
    <span class="n">length</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">/=</span> <span class="n">length</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="random_vector"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.random_vector">[docs]</a><span class="k">def</span> <span class="nf">random_vector</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return array of random doubles in the half-open interval [0.0, 1.0).</span>

<span class="sd">    &gt;&gt;&gt; v = random_vector(10000)</span>
<span class="sd">    &gt;&gt;&gt; numpy.all(v &gt;= 0.0) and numpy.all(v &lt; 1.0)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; v0 = random_vector(10)</span>
<span class="sd">    &gt;&gt;&gt; v1 = random_vector(10)</span>
<span class="sd">    &gt;&gt;&gt; numpy.any(v0 == v1)</span>
<span class="sd">    False</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="p">)</span></div>


<div class="viewcode-block" id="inverse_matrix"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.inverse_matrix">[docs]</a><span class="k">def</span> <span class="nf">inverse_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return inverse of square transformation matrix.</span>

<span class="sd">    &gt;&gt;&gt; M0 = random_rotation_matrix()</span>
<span class="sd">    &gt;&gt;&gt; M1 = inverse_matrix(M0.T)</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(M1, numpy.linalg.inv(M0.T))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; for size in range(1, 7):</span>
<span class="sd">    ...     M0 = numpy.random.rand(size, size)</span>
<span class="sd">    ...     M1 = inverse_matrix(M0)</span>
<span class="sd">    ...     if not numpy.allclose(M1, numpy.linalg.inv(M0)): print size</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span></div>


<div class="viewcode-block" id="concatenate_matrices"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.concatenate_matrices">[docs]</a><span class="k">def</span> <span class="nf">concatenate_matrices</span><span class="p">(</span><span class="o">*</span><span class="n">matrices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return concatenation of series of transformation matrices.</span>

<span class="sd">    &gt;&gt;&gt; M = numpy.random.rand(16).reshape((4, 4)) - 0.5</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(M, concatenate_matrices(M))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; numpy.allclose(numpy.dot(M, M.T), concatenate_matrices(M, M.T))</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">matrices</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="is_same_transform"><a class="viewcode-back" href="../../../../../helping_hands_rl_envs.simulators.pybullet.utils.html#helping_hands_rl_envs.simulators.pybullet.utils.transformations.is_same_transform">[docs]</a><span class="k">def</span> <span class="nf">is_same_transform</span><span class="p">(</span><span class="n">matrix0</span><span class="p">,</span> <span class="n">matrix1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return True if two matrices perform same transformation.</span>

<span class="sd">    &gt;&gt;&gt; is_same_transform(numpy.identity(4), numpy.identity(4))</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; is_same_transform(numpy.identity(4), random_rotation_matrix())</span>
<span class="sd">    False</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matrix0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">matrix0</span> <span class="o">/=</span> <span class="n">matrix0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">matrix1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">matrix1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">matrix1</span> <span class="o">/=</span> <span class="n">matrix1</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">matrix0</span><span class="p">,</span> <span class="n">matrix1</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;_py_&#39;</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Try import all public attributes from module into global namespace.</span>

<span class="sd">    Existing attributes with name clashes are renamed with prefix.</span>
<span class="sd">    Attributes starting with underscore are ignored by default.</span>

<span class="sd">    Return True on successful import.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Failed to import module &quot;</span> <span class="o">+</span> <span class="n">module_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ignore</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ignore</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
                    <span class="nb">globals</span><span class="p">()[</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">attr</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">warn</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No Python implementation of &quot;</span> <span class="o">+</span> <span class="n">attr</span><span class="p">)</span>
            <span class="nb">globals</span><span class="p">()[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">HelpingHandsEnvs</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Colin Kohler, Dian Wang.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>