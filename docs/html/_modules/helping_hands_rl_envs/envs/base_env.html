
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>helping_hands_rl_envs.envs.base_env &#8212; HelpingHandsEnvs 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HelpingHandsEnvs 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">helping_hands_rl_envs.envs.base_env</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for helping_hands_rl_envs.envs.base_env</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">.. moduleauthor: Colin Kohler &lt;github.com/ColinKohler&gt;</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.random</span> <span class="k">as</span> <span class="nn">npr</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">median_filter</span>
<span class="kn">import</span> <span class="nn">skimage.transform</span> <span class="k">as</span> <span class="nn">sk_transform</span>

<span class="kn">import</span> <span class="nn">pybullet</span> <span class="k">as</span> <span class="nn">pb</span>
<span class="kn">import</span> <span class="nn">pybullet_data</span>

<span class="kn">import</span> <span class="nn">helping_hands_rl_envs.pybullet.utils.constants</span> <span class="k">as</span> <span class="nn">constants</span>
<span class="kn">from</span> <span class="nn">helping_hands_rl_envs.pybullet.utils</span> <span class="kn">import</span> <span class="n">transformations</span>
<span class="kn">import</span> <span class="nn">helping_hands_rl_envs.envs.configs</span> <span class="k">as</span> <span class="nn">env_configs</span>

<span class="kn">from</span> <span class="nn">helping_hands_rl_envs.pybullet.robots.ur5_simple</span> <span class="kn">import</span> <span class="n">UR5_Simple</span>
<span class="kn">from</span> <span class="nn">helping_hands_rl_envs.pybullet.robots.ur5_robotiq</span> <span class="kn">import</span> <span class="n">UR5_Robotiq</span>
<span class="kn">from</span> <span class="nn">helping_hands_rl_envs.pybullet.robots.kuka</span> <span class="kn">import</span> <span class="n">Kuka</span>
<span class="kn">from</span> <span class="nn">helping_hands_rl_envs.pybullet.robots.panda</span> <span class="kn">import</span> <span class="n">Panda</span>
<span class="kn">from</span> <span class="nn">helping_hands_rl_envs.pybullet.utils.sensor</span> <span class="kn">import</span> <span class="n">Sensor</span>
<span class="kn">from</span> <span class="nn">helping_hands_rl_envs.pybullet.objects.pybullet_object</span> <span class="kn">import</span> <span class="n">PybulletObject</span>
<span class="kn">import</span> <span class="nn">helping_hands_rl_envs.pybullet.utils.object_generation</span> <span class="k">as</span> <span class="nn">pb_obj_generation</span>
<span class="kn">from</span> <span class="nn">helping_hands_rl_envs.pybullet.utils.constants</span> <span class="kn">import</span> <span class="n">NoValidPositionException</span>

<div class="viewcode-block" id="BaseEnv"><a class="viewcode-back" href="../../../index.html#helping_hands_rl_envs.envs.base_env.BaseEnv">[docs]</a><span class="k">class</span> <span class="nc">BaseEnv</span><span class="p">:</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  Base Env Class.</span>

<span class="sd">  Args:</span>
<span class="sd">    config: Config used to specify various environment details</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="c1"># Load the default config and replace any duplicate values with the config</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">env_configs</span><span class="o">.</span><span class="n">DEFAULT_CONFIG</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span>
    <span class="n">npr</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># Setup environment</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;workspace&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">workspace_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pos_candidate</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pos_candidate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span> <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pos_candidate&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_steps</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_steps&#39;</span><span class="p">]</span>

    <span class="c1"># Setup heightmap</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;obs_size&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;in_hand_size&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_mode</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;in_hand_mode&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span>

    <span class="c1"># Setup action format</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;action_sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">assert</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;action_sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">action_sequence</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;action_sequence&#39;</span><span class="p">]</span>

    <span class="c1"># Setup observation and action spaces</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">obs_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_shape</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_primatives</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">NUM_PRIMATIVES</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
    <span class="n">primative_idx</span><span class="p">,</span> <span class="n">x_idx</span><span class="p">,</span> <span class="n">y_idx</span><span class="p">,</span> <span class="n">z_idx</span><span class="p">,</span> <span class="n">rot_idx</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_sequence</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">primative_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">action_has_primative</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">x_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">y_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">z_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">rot_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">action_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="c1"># Connect to pybullet and add data files to path</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;render&#39;</span><span class="p">]:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">GUI</span><span class="p">)</span>
      <span class="c1"># For screenshotting envs</span>
      <span class="c1"># pb.configureDebugVisualizer(pb.COV_ENABLE_GUI, 0)</span>
      <span class="c1"># pb.resetDebugVisualizerCamera(</span>
      <span class="c1">#     cameraDistance=1.1,</span>
      <span class="c1">#     cameraYaw=90,</span>
      <span class="c1">#     cameraPitch=-40,</span>
      <span class="c1">#     cameraTargetPosition=[0, 0, 0])</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">DIRECT</span><span class="p">)</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">setAdditionalSearchPath</span><span class="p">(</span><span class="n">pybullet_data</span><span class="o">.</span><span class="n">getDataPath</span><span class="p">())</span>

    <span class="c1"># Environment specific variables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dynamic</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;fast_mode&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_timestep</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">240.</span>

    <span class="c1"># Setup robot</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ur5&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">robot</span> <span class="o">=</span> <span class="n">UR5_Simple</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ur5_robotiq&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">robot</span> <span class="o">=</span> <span class="n">UR5_Robotiq</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;kuka&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">robot</span> <span class="o">=</span> <span class="n">Kuka</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;panda&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">robot</span> <span class="o">=</span> <span class="n">Panda</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># Setup physics mode</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;physics_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fast&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">physics_mode</span> <span class="o">=</span> <span class="s1">&#39;fast&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">num_solver_iterations</span> <span class="o">=</span> <span class="mi">50</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">solver_residual_threshold</span> <span class="o">=</span> <span class="mf">1e-7</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">position_gain</span> <span class="o">=</span> <span class="mf">0.02</span>
    <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;physics_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;slow&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">physics_mode</span> <span class="o">=</span> <span class="s1">&#39;slow&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">num_solver_iterations</span> <span class="o">=</span> <span class="mi">200</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">solver_residual_threshold</span> <span class="o">=</span> <span class="mf">1e-7</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">position_gain</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;physics_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">physics_mode</span> <span class="o">=</span> <span class="s1">&#39;custom&#39;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">num_solver_iterations</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_solver_iterations&#39;</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">solver_residual_threshold</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;solver_residual_threshold&#39;</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">position_gain</span> <span class="o">=</span> <span class="mf">0.01</span>

    <span class="c1"># TODO: Move this somewhere it makes sense</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">block_original_size</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">block_scale_range</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;object_scale_range&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_block_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_original_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_scale_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_original_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_scale_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">pick_pre_offset</span> <span class="o">=</span> <span class="mf">0.10</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pick_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_scale_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">block_original_size</span><span class="o">/</span><span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">place_pre_offset</span> <span class="o">=</span> <span class="mf">0.10</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">place_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_scale_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">block_original_size</span><span class="o">/</span><span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pull_offset</span> <span class="o">=</span> <span class="mf">0.25</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">object_init_z</span> <span class="o">=</span> <span class="mf">0.020</span>

    <span class="c1"># Setup camera</span>
    <span class="n">ws_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">cam_pos</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">10</span><span class="p">]</span>
    <span class="n">target_pos</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">cam_up_vector</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">Sensor</span><span class="p">(</span><span class="n">cam_pos</span><span class="p">,</span> <span class="n">cam_up_vector</span><span class="p">,</span> <span class="n">target_pos</span><span class="p">,</span> <span class="n">ws_size</span><span class="p">,</span> <span class="n">cam_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cam_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Rest pose for arm</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">getQuaternionFromEuler</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rest_pose</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">rot</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">object_types</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">simulate_grasp</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;simulate_grasp&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">perfect_grasp</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;perfect_grasp&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">perfect_place</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;perfect_place&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">workspace_check</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;workspace_check&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_random_objects</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_random_objects&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">random_orientation</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;random_orientation&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">check_random_obj_valid</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;check_random_obj_valid&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">random_orientation</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;random_orientation&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_obj</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;num_objects&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reward_type</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;reward_type&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">object_type</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;object_type&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hard_reset_freq</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;hard_reset_freq&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_object_distance</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;min_object_distance&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_boarder_padding</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;min_boarder_padding&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">deconstruct_init_offset</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;deconstruct_init_offset&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pick_top_down_approach</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pick_top_down_approach&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">place_top_down_approach</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;place_top_down_approach&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">half_rotation</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;half_rotation&#39;</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">adjust_gripper_after_lift</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;adjust_gripper_after_lift&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;robot&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;kuka&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">adjust_gripper_offset</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;kuka_adjust_gripper_offset&#39;</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">episode_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">heightmap</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_episode_steps</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_obj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pb_state</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="BaseEnv.initialize"><a class="viewcode-back" href="../../../index.html#helping_hands_rl_envs.envs.base_env.BaseEnv.initialize">[docs]</a>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Initialize the pybullet world.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">resetSimulation</span><span class="p">()</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">setPhysicsEngineParameter</span><span class="p">(</span><span class="n">numSubSteps</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">numSolverIterations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_solver_iterations</span><span class="p">,</span>
                                 <span class="n">solverResidualThreshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_residual_threshold</span><span class="p">,</span>
                                 <span class="n">constraintSolverType</span><span class="o">=</span><span class="n">pb</span><span class="o">.</span><span class="n">CONSTRAINT_SOLVER_LCP_SI</span><span class="p">)</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">setTimeStep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timestep</span><span class="p">)</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">setGravity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># TODO: These might have to be in the config depending on how they effect the solver_residual_threshold</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">loadURDF</span><span class="p">(</span><span class="s1">&#39;plane.urdf&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">changeDynamics</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">linearDamping</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">angularDamping</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">restitution</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">contactStiffness</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">contactDamping</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Load the UR5 and set it to the home positions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

    <span class="c1"># Reset episode vars</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">object_types</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">heightmap</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_episode_steps</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Step simulation</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">stepSimulation</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseEnv.resetPybulletWorkspace"><a class="viewcode-back" href="../../../index.html#helping_hands_rl_envs.envs.base_env.BaseEnv.resetPybulletWorkspace">[docs]</a>  <span class="k">def</span> <span class="nf">resetPybulletWorkspace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Reset the PyBullet world to just contain the robot.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># soft reset has bug in older pybullet versions. 2.7,1 works good</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">episode_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">episode_count</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hard_reset_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">episode_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">removeBody</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">object_id</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">object_types</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">heightmap</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">current_episode_steps</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">last_obj</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">pb_state</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generateShapes</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">RANDOM</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_random_objects</span><span class="p">,</span> <span class="n">random_orientation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="n">pb</span><span class="o">.</span><span class="n">stepSimulation</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseEnv.reset"><a class="viewcode-back" href="../../../index.html#helping_hands_rl_envs.envs.base_env.BaseEnv.reset">[docs]</a>  <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Reset the environment.</span>

<span class="sd">    Returns: Numpy vector of the observation</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resetPybulletWorkspace</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getObservation</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseEnv.step"><a class="viewcode-back" href="../../../index.html#helping_hands_rl_envs.envs.base_env.BaseEnv.step">[docs]</a>  <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Take an action in the enviornment.</span>

<span class="sd">    Args:</span>
<span class="sd">      - action: Int indicating the action to take</span>

<span class="sd">    Returns: (obs, reward, done)</span>
<span class="sd">      - obs: Numpy vector of the observation</span>
<span class="sd">      - reward: Double of the reward given</span>
<span class="sd">      - done: Bool flag indicating if the episode is done</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">takeAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getObservation</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkTermination</span><span class="p">()</span>
    <span class="n">reward</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">done</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
      <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_episode_steps</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_steps</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSimValid</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_episode_steps</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span></div>

  <span class="k">def</span> <span class="nf">takeAction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="n">motion_primative</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decodeAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="n">action</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">holding_obj</span>

    <span class="c1"># Get transform for action</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">]</span>
    <span class="n">rot_q</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">getQuaternionFromEuler</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>

    <span class="c1"># Take action specfied by motion primative</span>
    <span class="k">if</span> <span class="n">motion_primative</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">PICK_PRIMATIVE</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">holding_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfect_grasp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkPerfectGrasp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">):</span>
          <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">pick</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pick_pre_offset</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic</span><span class="p">,</span>
                        <span class="n">objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">,</span> <span class="n">simulate_grasp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simulate_grasp</span><span class="p">,</span> <span class="n">top_down_approach</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pick_top_down_approach</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">motion_primative</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">PLACE_PRIMATIVE</span><span class="p">:</span>
      <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">holding_obj</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">holding_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfect_place</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkPerfectPlace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">):</span>
          <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_pre_offset</span><span class="p">,</span>
                         <span class="n">dynamic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic</span><span class="p">,</span> <span class="n">simulate_grasp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simulate_grasp</span><span class="p">,</span> <span class="n">top_down_approach</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">place_top_down_approach</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">motion_primative</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">PUSH_PRIMATIVE</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">motion_primative</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">PULL_PRIMATIVE</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">pull</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rot_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pull_offset</span><span class="p">,</span> <span class="n">dynamic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Bad motion primative supplied for action.&#39;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">isSimValid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_random_obj_valid</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_types</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">RANDOM</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isObjectHeld</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace_check</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isPointInWorkspace</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
          <span class="k">return</span> <span class="kc">False</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isObjectWithinWorkspace</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
          <span class="k">return</span> <span class="kc">False</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_candidate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_candidate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.02</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_candidate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>
          <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

  <span class="k">def</span> <span class="nf">areObjectsInWorkspace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isObjectHeld</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">continue</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace_check</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isPointInWorkspace</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
          <span class="k">return</span> <span class="kc">False</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isObjectWithinWorkspace</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
          <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

  <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
    <span class="p">[</span><span class="n">pb</span><span class="o">.</span><span class="n">stepSimulation</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iteration</span><span class="p">)]</span>

  <span class="k">def</span> <span class="nf">didBlockFall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>

    <span class="n">motion_primative</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decodeAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_action</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_obj</span>

    <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">motion_primative</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">PLACE_PRIMATIVE</span> <span class="ow">and</span> \
             <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getXYPosition</span><span class="p">())</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">obj</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>

  <span class="k">def</span> <span class="nf">getValidSpace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span>

  <span class="k">def</span> <span class="nf">_getObservation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;&#39;&#39;&#39;</span>
    <span class="n">old_heightmap</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heightmap</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">heightmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getHeightmap</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isHolding</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
      <span class="n">in_hand_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEmptyInHand</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">motion_primative</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decodeAction</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
      <span class="n">in_hand_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInHandImage</span><span class="p">(</span><span class="n">old_heightmap</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isHolding</span><span class="p">(),</span> <span class="n">in_hand_img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="p">])</span>

  <span class="k">def</span> <span class="nf">_getHeightmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sensor</span><span class="o">.</span><span class="n">getHeightmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_getValidPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">border_padding</span><span class="p">,</span> <span class="n">min_distance</span><span class="p">,</span> <span class="n">existing_positions</span><span class="p">,</span> <span class="n">num_shapes</span><span class="p">,</span> <span class="n">sample_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">existing_positions_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">existing_positions</span><span class="p">)</span>
    <span class="n">sample_range</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sample_range</span><span class="p">)</span>
    <span class="n">valid_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_shapes</span><span class="p">):</span>
      <span class="c1"># Generate random drop config</span>
      <span class="n">x_extents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">y_extents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

      <span class="n">is_position_valid</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_position_valid</span><span class="p">:</span>
          <span class="k">break</span>
        <span class="k">if</span> <span class="n">sample_range</span><span class="p">:</span>
          <span class="n">sample_range</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sample_range</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">border_padding</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
          <span class="n">sample_range</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sample_range</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">border_padding</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
          <span class="n">sample_range</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sample_range</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">border_padding</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
          <span class="n">sample_range</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sample_range</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">border_padding</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
          <span class="n">position</span> <span class="o">=</span> <span class="p">[(</span><span class="n">sample_range</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sample_range</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">npr</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">+</span> <span class="n">sample_range</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                      <span class="p">(</span><span class="n">sample_range</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sample_range</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">npr</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">+</span> <span class="n">sample_range</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">position</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x_extents</span> <span class="o">-</span> <span class="n">border_padding</span><span class="p">)</span> <span class="o">*</span> <span class="n">npr</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">border_padding</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="p">(</span><span class="n">y_extents</span> <span class="o">-</span> <span class="n">border_padding</span><span class="p">)</span> <span class="o">*</span> <span class="n">npr</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>  <span class="n">border_padding</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_candidate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_candidate</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_candidate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
          <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_candidate</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_candidate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">border_padding</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">border_padding</span><span class="o">/</span><span class="mi">2</span> <span class="ow">and</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">border_padding</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValidSpace</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">border_padding</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">existing_positions_copy</span><span class="p">:</span>
          <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-</span><span class="n">position</span><span class="p">),</span> <span class="n">existing_positions_copy</span><span class="p">)))</span>
          <span class="n">is_position_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">distances</span> <span class="o">&gt;</span> <span class="n">min_distance</span><span class="p">)</span>
          <span class="c1"># is_position_valid = np.all(np.sum(np.abs(np.array(positions) - np.array(position[:-1])), axis=1) &gt; min_distance)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">is_position_valid</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="k">if</span> <span class="n">is_position_valid</span><span class="p">:</span>
        <span class="n">existing_positions_copy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
        <span class="n">valid_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_positions</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_shapes</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">valid_positions</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">NoValidPositionException</span>

  <span class="k">def</span> <span class="nf">_getValidOrientation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_orientation</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">random_orientation</span><span class="p">:</span>
      <span class="n">orientation</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">getQuaternionFromEuler</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">()])</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">orientation</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">getQuaternionFromEuler</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">orientation</span>

  <span class="k">def</span> <span class="nf">_getDefaultBoarderPadding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">shape_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">CUBE</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">TRIANGLE</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">RANDOM</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">CYLINDER</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">RANDOM_BLOCK</span><span class="p">,</span>
                      <span class="n">constants</span><span class="o">.</span><span class="n">RANDOM_HOUSEHOLD</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">BOTTLE</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">TEST_TUBE</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">SWAB</span><span class="p">):</span>
      <span class="n">padding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span> <span class="o">*</span> <span class="mf">2.4</span>
    <span class="k">elif</span> <span class="n">shape_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">BRICK</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">ROOF</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">CUP</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">SPOON</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">BOX</span><span class="p">,</span>
                        <span class="n">constants</span><span class="o">.</span><span class="n">FLAT_BLOCK</span><span class="p">):</span>
      <span class="n">padding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span> <span class="o">*</span> <span class="mf">3.4</span>
    <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">BOWL</span><span class="p">:</span>
      <span class="n">padding</span> <span class="o">=</span> <span class="mf">0.17</span>
    <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">PLATE</span><span class="p">:</span>
      <span class="n">padding</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Attempted to generate invalid shape.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">padding</span>

  <span class="k">def</span> <span class="nf">_getDefaultMinDistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">shape_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">CUBE</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">TRIANGLE</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">RANDOM</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">CYLINDER</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">RANDOM_BLOCK</span><span class="p">,</span>
                      <span class="n">constants</span><span class="o">.</span><span class="n">BOTTLE</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">TEST_TUBE</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">SWAB</span><span class="p">):</span>
      <span class="n">min_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span> <span class="o">*</span> <span class="mf">2.4</span>
    <span class="k">elif</span> <span class="n">shape_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">BRICK</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">ROOF</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">CUP</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">SPOON</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">BOX</span><span class="p">,</span>
                        <span class="n">constants</span><span class="o">.</span><span class="n">FLAT_BLOCK</span><span class="p">):</span>
      <span class="n">min_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span> <span class="o">*</span> <span class="mf">3.4</span>
    <span class="k">elif</span> <span class="n">shape_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">RANDOM_HOUSEHOLD</span><span class="p">]:</span>
      <span class="n">min_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span> <span class="o">*</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">BOWL</span><span class="p">:</span>
      <span class="n">min_distance</span> <span class="o">=</span> <span class="mf">0.17</span>
    <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">PLATE</span><span class="p">:</span>
      <span class="n">min_distance</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Attempted to generate invalid shape.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">min_distance</span>

  <span class="k">def</span> <span class="nf">_getExistingXYPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">getXYPosition</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">_generateShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_shapes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">min_distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_orientation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">z_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;&#39;&#39;&#39;</span>
    <span class="c1"># if padding is not set, use the default padding</span>
    <span class="k">if</span> <span class="n">padding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">padding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDefaultBoarderPadding</span><span class="p">(</span><span class="n">shape_type</span><span class="p">)</span>

    <span class="c1"># if self.min_boarder_padding is set, padding can not be smaller than self.min_boarder_padding</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_boarder_padding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">padding</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">padding</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_boarder_padding</span><span class="p">)</span>

    <span class="c1"># if min_distance is not set, use the default min_distance</span>
    <span class="k">if</span> <span class="n">min_distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">min_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getDefaultMinDistance</span><span class="p">(</span><span class="n">shape_type</span><span class="p">)</span>

    <span class="c1"># if self.min_object_distance is set, min_distance can not be smaller than self.min_object_distance</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_distance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">min_distance</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_distance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_object_distance</span><span class="p">)</span>

    <span class="n">shape_handles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getExistingXYPositions</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">valid_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getValidPositions</span><span class="p">(</span><span class="n">padding</span><span class="p">,</span> <span class="n">min_distance</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">num_shapes</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">valid_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
      <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">valid_positions</span><span class="p">:</span>
        <span class="n">position</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_init_z</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">valid_positions</span> <span class="o">=</span> <span class="n">pos</span>

    <span class="k">if</span> <span class="n">rot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">orientations</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_getValidOrientation</span><span class="p">(</span><span class="n">random_orientation</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_shapes</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">orientations</span> <span class="o">=</span> <span class="n">rot</span>


    <span class="k">for</span> <span class="n">position</span><span class="p">,</span> <span class="n">orientation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">valid_positions</span><span class="p">,</span> <span class="n">orientations</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">scale</span><span class="p">:</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">npr</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block_scale_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_scale_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">CUBE</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateCube</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">BRICK</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateBrick</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TRIANGLE</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateTriangle</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">ROOF</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateRoof</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">CYLINDER</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateCylinder</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">RANDOM</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateRandomObj</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">z_scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">CUP</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateCup</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">BOWL</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateBowl</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">PLATE</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generatePlate</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">model_id</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">RANDOM_BLOCK</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateRandomBlock</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">RANDOM_HOUSEHOLD</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateRandomHouseHoldObj</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">SPOON</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateSpoon</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">BOTTLE</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateBottle</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">BOX</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateBox</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TEST_TUBE</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateTestTube</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">SWAB</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateSwab</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">model_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">FLAT_BLOCK</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateFlatBlock</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">RANDOM_HOUSEHOLD200</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateRandomHouseHoldObj200</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">model_id</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">GRASP_NET_OBJ</span><span class="p">:</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">pb_obj_generation</span><span class="o">.</span><span class="n">generateGraspNetObject</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">model_id</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">physics_mode</span> <span class="o">==</span> <span class="s1">&#39;slow&#39;</span><span class="p">:</span>
        <span class="n">pb</span><span class="o">.</span><span class="n">changeDynamics</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">linearDamping</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">angularDamping</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">restitution</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">contactStiffness</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">contactDamping</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
      <span class="n">shape_handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">shape_handles</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">shape_handles</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">object_types</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape_type</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shape_handles</span>

  <span class="k">def</span> <span class="nf">getObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">objs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isObjectHeld</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">continue</span>
      <span class="n">objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">objs</span>

  <span class="k">def</span> <span class="nf">getObjectPoses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">objects</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span>

    <span class="n">obj_poses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isObjectHeld</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">continue</span>
      <span class="n">pos</span><span class="p">,</span> <span class="n">rot</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getPose</span><span class="p">()</span>
      <span class="n">rot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertQuaternionToEuler</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>

      <span class="n">obj_poses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">rot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj_poses</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">getObjectPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">omit_hold</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">obj_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">omit_hold</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isObjectHeld</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">continue</span>
      <span class="n">obj_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getPosition</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj_positions</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_getHoldingObj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">holding_obj</span>

  <span class="k">def</span> <span class="nf">_getHoldingObjType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_types</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_getHoldingObj</span><span class="p">()]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">holding_obj</span> <span class="k">else</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">_isHolding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">holding_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

  <span class="k">def</span> <span class="nf">_getRestPoseMatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">T</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">getMatrixFromQuaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rest_pose</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">T</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest_pose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">T</span>

  <span class="k">def</span> <span class="nf">_isObjectHeld</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">holding_obj</span> <span class="o">==</span> <span class="n">obj</span>

  <span class="k">def</span> <span class="nf">_removeObject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
      <span class="n">pb</span><span class="o">.</span><span class="n">removeBody</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">object_id</span><span class="p">)</span>
      <span class="c1"># self._moveObjectOutWorkspace(obj)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">openGripper</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_moveObjectOutWorkspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">resetPose</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">pb</span><span class="o">.</span><span class="n">getQuaternionFromEuler</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]))</span>

  <span class="k">def</span> <span class="nf">_isObjOnTop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">objects</span><span class="p">:</span>
      <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span>
    <span class="n">obj_position</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isObjectHeld</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">or</span> <span class="n">o</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="n">block_position</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">block_position</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">obj_position</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_original_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_scale_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> \
          <span class="n">block_position</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">obj_position</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

  <span class="k">def</span> <span class="nf">_isObjOnGround</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">contact_points</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getContactPoints</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">contact_points</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

  <span class="k">def</span> <span class="nf">_getNumTopBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">blocks</span><span class="p">:</span>
      <span class="n">blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span>
    <span class="n">cluster_pos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isObjectHeld</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">continue</span>
      <span class="n">block_position</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span>
      <span class="n">cluster_flag</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">cluster_pos</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">block_position</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_original_size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">block_scale_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">):</span>
          <span class="n">cluster</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block_position</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
          <span class="n">cluster_flag</span> <span class="o">=</span> <span class="kc">True</span>
          <span class="k">break</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">cluster_flag</span><span class="p">:</span>
        <span class="n">cluster_pos</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">block_position</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_pos</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isHolding</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">_checkStack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objects</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">objects</span><span class="p">:</span>
      <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isObjectHeld</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">getZPosition</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">objects</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">continue</span>
      <span class="c1">#TODO: not 100% sure about this</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">isTouching</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">isTouching</span><span class="p">(</span><span class="n">PybulletObject</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">False</span>
      <span class="c1"># the xy positions of the blocks much be close. Otherwise the adjacent blocks will be considered as a stack</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">getXYPosition</span><span class="p">()),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">getXYPosition</span><span class="p">()),</span> <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

  <span class="k">def</span> <span class="nf">_checkPerfectGrasp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">objects</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    check if the grasp at (x, y, z, rot) is a perfect grasp (gripper&#39;s rotation aligned with the object&#39;s rotation)</span>
<span class="sd">    this method only checks rz, and only works for basic block stacking tasks</span>
<span class="sd">    :param x: x of the grasp pose</span>
<span class="sd">    :param y: y of the grasp pose</span>
<span class="sd">    :param z: z of the grasp pose</span>
<span class="sd">    :param rot: rotation of the grasp pose</span>
<span class="sd">    :param objects: candidate objects to grasp</span>
<span class="sd">    :return: True if the relative rotation between the gripper and the target object is smaller than pi/12</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">end_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
    <span class="n">sorted_obj</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">end_pos</span> <span class="o">-</span> <span class="n">o</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()))</span>
    <span class="n">obj_pos</span><span class="p">,</span> <span class="n">obj_rot</span> <span class="o">=</span> <span class="n">sorted_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getPose</span><span class="p">()</span>
    <span class="n">obj_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_types</span><span class="p">[</span><span class="n">sorted_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1"># For cylinders, the gripper is always aligned</span>
    <span class="k">if</span> <span class="n">obj_type</span> <span class="ow">is</span> <span class="n">constants</span><span class="o">.</span><span class="n">CYLINDER</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">True</span>
    <span class="n">obj_rot</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">getEulerFromQuaternion</span><span class="p">(</span><span class="n">obj_rot</span><span class="p">)</span>
    <span class="c1"># The relative angle between the gripper and the target object in [0, pi] range</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">obj_rot</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="c1"># Cubes are symmetric for pi/2 rotation</span>
    <span class="k">if</span> <span class="n">obj_type</span> <span class="ow">is</span> <span class="n">constants</span><span class="o">.</span><span class="n">CUBE</span><span class="p">:</span>
      <span class="k">while</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">angle</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
      <span class="n">angle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">angle</span><span class="p">)</span>
    <span class="c1"># Bricks, roofs, and triangles are symmetric for pi rotation</span>
    <span class="k">elif</span> <span class="n">obj_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">BRICK</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">ROOF</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">TRIANGLE</span><span class="p">]:</span>
      <span class="n">angle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">angle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">12</span>

  <span class="k">def</span> <span class="nf">_checkPerfectPlace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">objects</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    check if the place at (x, y, z, rot) is a perfect place (gripper&#39;s rotation aligned with the object&#39;s rotation)</span>
<span class="sd">    this method only checks rz, and only works for basic block stacking tasks</span>
<span class="sd">    :param x: x of the place pose</span>
<span class="sd">    :param y: y of the place pose</span>
<span class="sd">    :param z: z of the place pose</span>
<span class="sd">    :param rot: rotation of the place pose</span>
<span class="sd">    :param objects: candidate objects to place on</span>
<span class="sd">    :return: True if the relative rotation between the gripper and the target object is smaller than pi/12</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">end_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
    <span class="n">sorted_obj</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">end_pos</span> <span class="o">-</span> <span class="n">o</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()))</span>
    <span class="n">obj_pos</span><span class="p">,</span> <span class="n">obj_rot</span> <span class="o">=</span> <span class="n">sorted_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getPose</span><span class="p">()</span>
    <span class="n">holding_obj_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getHoldingObjType</span><span class="p">()</span>
    <span class="n">obj_rot</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">getEulerFromQuaternion</span><span class="p">(</span><span class="n">obj_rot</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">obj_rot</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">angle</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
      <span class="n">angle</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">angle</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">12</span>

  <span class="k">def</span> <span class="nf">_checkObjUpright</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">9</span><span class="p">):</span>
    <span class="n">triangle_rot</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getRotation</span><span class="p">()</span>
    <span class="n">triangle_rot</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">getEulerFromQuaternion</span><span class="p">(</span><span class="n">triangle_rot</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">triangle_rot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">triangle_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">threshold</span>

  <span class="k">def</span> <span class="nf">_checkOnTop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bottom_obj</span><span class="p">,</span> <span class="n">top_obj</span><span class="p">):</span>
    <span class="n">bottom_position</span> <span class="o">=</span> <span class="n">bottom_obj</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span>
    <span class="n">top_position</span> <span class="o">=</span> <span class="n">top_obj</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">top_position</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bottom_position</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_scale_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_original_size</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">top_obj</span><span class="o">.</span><span class="n">isTouching</span><span class="p">(</span><span class="n">bottom_obj</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_getDistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">):</span>
    <span class="n">position1</span> <span class="o">=</span> <span class="n">obj1</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span>
    <span class="n">position2</span> <span class="o">=</span> <span class="n">obj2</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position2</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_checkAdjacent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_1</span><span class="p">,</span> <span class="n">obj_2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">obj_1</span><span class="o">.</span><span class="n">getZPosition</span><span class="p">(),</span> <span class="n">obj_2</span><span class="o">.</span><span class="n">getZPosition</span><span class="p">(),</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">_getDistance</span><span class="p">(</span><span class="n">obj_1</span><span class="p">,</span> <span class="n">obj_2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">2.2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span>

  <span class="k">def</span> <span class="nf">_checkInBetween</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj0</span><span class="p">,</span> <span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">threshold</span><span class="p">:</span>
      <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span>
    <span class="n">position0</span> <span class="o">=</span> <span class="n">obj0</span><span class="o">.</span><span class="n">getXYPosition</span><span class="p">()</span>
    <span class="n">position1</span> <span class="o">=</span> <span class="n">obj1</span><span class="o">.</span><span class="n">getXYPosition</span><span class="p">()</span>
    <span class="n">position2</span> <span class="o">=</span> <span class="n">obj2</span><span class="o">.</span><span class="n">getXYPosition</span><span class="p">()</span>
    <span class="n">middle_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position2</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">middle_point</span> <span class="o">-</span> <span class="n">position0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">threshold</span>

  <span class="k">def</span> <span class="nf">_checkOriSimilar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">oris</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">pb</span><span class="o">.</span><span class="n">getEulerFromQuaternion</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">getRotation</span><span class="p">())[</span><span class="mi">2</span><span class="p">],</span> <span class="n">objects</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">oris</span><span class="p">,</span> <span class="n">oris</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_getPrimativeHeight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motion_primative</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the z position for the given action using the current heightmap.</span>
<span class="sd">    Args:</span>
<span class="sd">      - motion_primative: Pick/place motion primative</span>
<span class="sd">      - x: X coordinate for action</span>
<span class="sd">      - y: Y coordinate for action</span>
<span class="sd">      - offset: How much to offset the action along approach vector</span>
<span class="sd">    Returns: Valid Z coordinate for the action</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">x_pixel</span><span class="p">,</span> <span class="n">y_pixel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPixelsFromPos</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isHolding</span><span class="p">():</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_types</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">holding_obj</span><span class="p">]</span> <span class="ow">is</span> <span class="n">constants</span><span class="o">.</span><span class="n">BRICK</span><span class="p">:</span>
        <span class="n">extend</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">heightmap_resolution</span><span class="p">)</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_types</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">holding_obj</span><span class="p">]</span> <span class="ow">is</span> <span class="n">constants</span><span class="o">.</span><span class="n">ROOF</span><span class="p">:</span>
        <span class="n">extend</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">heightmap_resolution</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">extend</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">heightmap_resolution</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">extend</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">max_block_size</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">heightmap_resolution</span><span class="p">)</span>
    <span class="n">local_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x_pixel</span> <span class="o">-</span> <span class="n">extend</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_pixel</span> <span class="o">+</span> <span class="n">extend</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="p">)),</span> \
                                  <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y_pixel</span> <span class="o">-</span> <span class="n">extend</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_pixel</span> <span class="o">+</span> <span class="n">extend</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="p">))]</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">safe_z_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">local_region</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
      <span class="n">safe_z_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">motion_primative</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">PICK_PRIMATIVE</span><span class="p">:</span>
      <span class="n">safe_z_pos</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pick_offset</span>
      <span class="n">safe_z_pos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">safe_z_pos</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">safe_z_pos</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_offset</span>
    <span class="k">return</span> <span class="n">safe_z_pos</span>

  <span class="k">def</span> <span class="nf">convertQuaternionToEuler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rot</span><span class="p">):</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">getEulerFromQuaternion</span><span class="p">(</span><span class="n">rot</span><span class="p">))</span>

    <span class="c1"># TODO: This normalization should be improved</span>
    <span class="c1"># while rot[2] &lt; 0:</span>
    <span class="c1">#   rot[2] += np.pi</span>
    <span class="c1"># while rot[2] &gt; np.pi:</span>
    <span class="c1">#   rot[2] -= np.pi</span>

    <span class="k">return</span> <span class="n">rot</span>

  <span class="k">def</span> <span class="nf">normalizeRot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">):</span>
    <span class="k">while</span> <span class="n">rz</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">rz</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">while</span> <span class="n">rz</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
      <span class="n">rz</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">half_rotation</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">rz</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">rz</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="o">-</span><span class="n">rx</span>
        <span class="n">ry</span> <span class="o">=</span> <span class="o">-</span><span class="n">ry</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="p">)</span> <span class="ow">is</span> <span class="n">Kuka</span><span class="p">:</span>
        <span class="n">rz</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="o">-</span><span class="n">rx</span>
        <span class="n">ry</span> <span class="o">=</span> <span class="o">-</span><span class="n">ry</span>
    <span class="k">return</span> <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span>

  <span class="k">def</span> <span class="nf">_decodeAction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    decode input action base on self.action_sequence</span>
<span class="sd">    Args:</span>
<span class="sd">      action: action tensor</span>

<span class="sd">    Returns: motion_primative, x, y, z, rot</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">primative_idx</span><span class="p">,</span> <span class="n">x_idx</span><span class="p">,</span> <span class="n">y_idx</span><span class="p">,</span> <span class="n">z_idx</span><span class="p">,</span> <span class="n">rot_idx</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_sequence</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">])</span>
    <span class="n">motion_primative</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">primative_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">primative_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">x_idx</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">y_idx</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">z_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">z_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPrimativeHeight</span><span class="p">(</span><span class="n">motion_primative</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">rz</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_sequence</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">rz</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">rot_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
      <span class="n">ry</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_sequence</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">rz</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span><span class="p">]</span>
      <span class="n">ry</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">rx</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_sequence</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
      <span class="n">rz</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span><span class="p">]</span>
      <span class="n">ry</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">rx</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">rot</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">motion_primative</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span>

  <span class="k">def</span> <span class="nf">_encodeAction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
      <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rz</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ry</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">rz</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ry</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">rz</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ry</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">rz</span> <span class="o">=</span> <span class="n">r</span>
      <span class="n">ry</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">rz</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">rz</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="n">rz</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">rz</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="n">primitive_idx</span><span class="p">,</span> <span class="n">x_idx</span><span class="p">,</span> <span class="n">y_idx</span><span class="p">,</span> <span class="n">z_idx</span><span class="p">,</span> <span class="n">rot_idx</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_sequence</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
                                                      <span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">])</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_sequence</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">primitive_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">action</span><span class="p">[</span><span class="n">primitive_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">primitive</span>
    <span class="k">if</span> <span class="n">x_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">action</span><span class="p">[</span><span class="n">x_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">y_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">action</span><span class="p">[</span><span class="n">y_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
    <span class="k">if</span> <span class="n">z_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">action</span><span class="p">[</span><span class="n">z_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
    <span class="k">if</span> <span class="n">rot_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_sequence</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rz</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_sequence</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rz</span>
        <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rx</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_sequence</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rz</span>
        <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ry</span>
        <span class="n">action</span><span class="p">[</span><span class="n">rot_idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rx</span>

    <span class="k">return</span> <span class="n">action</span>

  <span class="k">def</span> <span class="nf">_checkTermination</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sub-envs should override this to set their own termination conditions</span>
<span class="sd">    Returns: False</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="kc">False</span>

  <span class="k">def</span> <span class="nf">_getShapeName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape_type</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Get the shape name from the type (int) &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CUBE</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;cube&#39;</span>
    <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPHERE</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;sphere&#39;</span>
    <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CYLINDER</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;cylinder&#39;</span>
    <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONE</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;cone&#39;</span>
    <span class="k">elif</span> <span class="n">shape_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">BRICK</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;brick&#39;</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>

  <span class="k">def</span> <span class="nf">_getPrimativeHeight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motion_primative</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the z position for the given action using the current heightmap.</span>
<span class="sd">    Args:</span>
<span class="sd">      - motion_primative: Pick/place motion primative</span>
<span class="sd">      - x: X coordinate for action</span>
<span class="sd">      - y: Y coordinate for action</span>
<span class="sd">      - offset: How much to offset the action along approach vector</span>
<span class="sd">    Returns: Valid Z coordinate for the action</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">x_pixel</span><span class="p">,</span> <span class="n">y_pixel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPixelsFromPos</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">local_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x_pixel</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_pixel</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="p">)),</span> \
                                  <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y_pixel</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_pixel</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="o">/</span><span class="mi">20</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_size</span><span class="p">))]</span>
    <span class="n">safe_z_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">local_region</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">safe_z_pos</span> <span class="o">=</span> <span class="n">safe_z_pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="k">if</span> <span class="n">motion_primative</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">PICK_PRIMATIVE</span> <span class="k">else</span> <span class="n">safe_z_pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>

    <span class="k">return</span> <span class="n">safe_z_pos</span>

  <span class="k">def</span> <span class="nf">_getPixelsFromPos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get the x/y pixels on the heightmap for the given coordinates</span>
<span class="sd">    Args:</span>
<span class="sd">      - x: X coordinate</span>
<span class="sd">      - y: Y coordinate</span>
<span class="sd">    Returns: (x, y) in pixels corresponding to coordinates</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">x_pixel</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_resolution</span>
    <span class="n">y_pixel</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_resolution</span>

    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_pixel</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">y_pixel</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_getPosFromPixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_pixel</span><span class="p">,</span> <span class="n">y_pixel</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_pixel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_resolution</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y_pixel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">heightmap_resolution</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

  <span class="k">def</span> <span class="nf">_isObjectOnCandidatePose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks if the object has drifted off the candidate positions.</span>
<span class="sd">    Args:</span>
<span class="sd">      - obs: A simulated object</span>
<span class="sd">    Returns: True if object is close to a candidate position, False otherwise</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getPosition</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_candidate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.02</span> <span class="ow">or</span> \
           <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_candidate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.02</span>

  <span class="k">def</span> <span class="nf">_isObjectWithinWorkspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks if the object is entirely within the workspace.</span>
<span class="sd">    Args:</span>
<span class="sd">      - obs: A simulated object</span>
<span class="sd">    Returns: True if bounding box of object is within workspace, False otherwise</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">xyz_min</span><span class="p">,</span> <span class="n">xyz_max</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">getBoundingBox</span><span class="p">()</span>
    <span class="c1"># TODO: Need to always use max z value as min z value is just under zero</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz_min</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xyz_min</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xyz_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz_min</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xyz_max</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xyz_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xyz_min</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xyz_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
    <span class="n">p4</span> <span class="o">=</span> <span class="n">xyz_max</span>

    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isPointInWorkspace</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p4</span><span class="p">]))</span>

  <span class="k">def</span> <span class="nf">_isPointInWorkspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks if the given point is within the workspace</span>
<span class="sd">    Args:</span>
<span class="sd">      - p: [x, y, z] point</span>
<span class="sd">    Returns: True in point is within workspace, False otherwise</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="ow">and</span> \
           <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="ow">and</span> \
           <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">getInHandImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heightmap</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">next_heightmap</span><span class="p">):</span>
    <span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">)</span> <span class="o">=</span> <span class="n">rot</span>
    <span class="c1"># Pad heightmaps for grasps near the edges of the workspace</span>
    <span class="n">heightmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">heightmap</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">next_heightmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">next_heightmap</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPixelsFromPos</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Get the corners of the crop</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">y_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Crop both heightmaps</span>
    <span class="n">crop</span> <span class="o">=</span> <span class="n">heightmap</span><span class="p">[</span><span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_mode</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="n">next_crop</span> <span class="o">=</span> <span class="n">next_heightmap</span><span class="p">[</span><span class="n">x_min</span><span class="p">:</span><span class="n">x_max</span><span class="p">,</span> <span class="n">y_min</span><span class="p">:</span><span class="n">y_max</span><span class="p">]</span>

      <span class="c1"># Adjust the in-hand image to remove background objects</span>
      <span class="n">next_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">next_crop</span><span class="p">)</span>
      <span class="n">crop</span><span class="p">[</span><span class="n">crop</span> <span class="o">&gt;=</span> <span class="n">next_max</span><span class="p">]</span> <span class="o">-=</span> <span class="n">next_max</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_mode</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;proj&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInHandOccupancyGridProj</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># end_effector rotate counter clockwise along z, so in hand img rotate clockwise</span>
      <span class="n">crop</span> <span class="o">=</span> <span class="n">sk_transform</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="o">-</span><span class="n">rz</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">crop</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">getInHandOccupancyGridProj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">rot</span><span class="p">):</span>
    <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span> <span class="o">=</span> <span class="n">rot</span>
    <span class="c1"># crop = zoom(crop, 2)</span>
    <span class="n">crop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span>

    <span class="n">zs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">z</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heightmap_resolution</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)])</span>
    <span class="n">zs</span> <span class="o">=</span> <span class="n">zs</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">zs</span> <span class="o">=</span> <span class="n">zs</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">crop</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ori_occupancy</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">zs</span>

    <span class="c1"># transform into points</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">ori_occupancy</span><span class="p">)</span>

    <span class="c1"># center</span>
    <span class="n">ori_point</span> <span class="o">=</span> <span class="n">point</span> <span class="o">-</span> <span class="n">size</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">transformations</span><span class="o">.</span><span class="n">euler_matrix</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">)[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ori_point</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">point</span> <span class="o">+</span> <span class="n">size</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">point</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">T</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">point</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">point</span><span class="o">.</span><span class="n">T</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span>

    <span class="n">occupancy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
    <span class="n">occupancy</span><span class="p">[</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">occupancy</span> <span class="o">=</span> <span class="n">median_filter</span><span class="p">(</span><span class="n">occupancy</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">occupancy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">occupancy</span><span class="p">)</span>

    <span class="n">projection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">occupancy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">occupancy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">occupancy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">projection</span>

  <span class="k">def</span> <span class="nf">getEmptyInHand</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_mode</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;proj&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hand_size</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_isPointInWorkspace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Checks if the given point is within the workspace</span>

<span class="sd">    Args:</span>
<span class="sd">      - p: [x, y, z] point</span>

<span class="sd">    Returns: True in point is within workspace, False otherwise</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

  <span class="k">def</span> <span class="nf">getStateDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">saveState</span><span class="p">()</span>
    <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;current_episode_steps&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_episode_steps</span><span class="p">),</span>
             <span class="s1">&#39;objects&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">),</span>
             <span class="s1">&#39;object_types&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_types</span><span class="p">),</span>
             <span class="s1">&#39;heightmap&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heightmap</span><span class="p">),</span>
             <span class="s1">&#39;robot_state&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">state</span><span class="p">),</span>
             <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">(),</span>
             <span class="s1">&#39;last_action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span><span class="p">,</span>
             <span class="s1">&#39;last_obj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_obj</span>
             <span class="p">}</span>
    <span class="k">return</span> <span class="n">state</span>

  <span class="k">def</span> <span class="nf">restoreStateDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_episode_steps</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;current_episode_steps&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">objects</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;objects&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">object_types</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;object_types&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">heightmap</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;heightmap&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;last_action&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_obj</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;last_obj&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;robot_state&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">robot</span><span class="o">.</span><span class="n">restoreState</span><span class="p">()</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;random_state&#39;</span><span class="p">])</span>

  <span class="k">def</span> <span class="nf">saveState</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pb_state</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">saveState</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStateDict</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">restoreState</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">restoreState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pb_state</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">restoreStateDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">saveEnvToFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">bullet_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;env.bullet&#39;</span><span class="p">)</span>
    <span class="n">pickle_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;env.pickle&#39;</span><span class="p">)</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">saveBullet</span><span class="p">(</span><span class="n">bullet_file</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getStateDict</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">loadEnvFromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">bullet_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;env.bullet&#39;</span><span class="p">)</span>
    <span class="n">pickle_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;env.pickle&#39;</span><span class="p">)</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">restoreState</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="n">bullet_file</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
      <span class="n">state</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">restoreStateDict</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">HelpingHandsEnvs 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">helping_hands_rl_envs.envs.base_env</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Colin Kohler, Dian Wang.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>